{"ast":null,"code":"/**\r\n * @author peterqliu / https://github.com/peterqliu\r\n * @author jscastro / https://github.com/jscastro76\r\n */\nconst utils = require(\"../utils/utils.js\");\nconst material = require(\"../utils/material.js\");\nconst THREE = require('../three.js');\nconst AnimationManager = require(\"../animation/AnimationManager.js\");\nconst CSS2D = require(\"./CSS2DRenderer.js\");\nfunction Objects() {}\nObjects.prototype = {\n  // standard 1px line with gl\n  line: function (obj) {\n    obj = utils._validate(obj, this._defaults.line);\n\n    //project to world and normalize\n    var straightProject = utils.lnglatsToWorld(obj.geometry);\n    var normalized = utils.normalizeVertices(straightProject);\n\n    //flatten array for buffergeometry\n    var flattenedArray = utils.flattenVectors(normalized.vertices);\n    var positions = new Float32Array(flattenedArray); // 3 vertices per point\n    var geometry = new THREE.BufferGeometry();\n    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));\n\n    // material\n    var material = new THREE.LineBasicMaterial({\n      color: 0xff0000,\n      linewidth: 21\n    });\n    var line = new THREE.Line(geometry, material);\n    line.options = options || {};\n    line.position.copy(normalized.position);\n    return line;\n  },\n  extrusion: function (options) {},\n  unenroll: function (obj, isStatic) {\n    var root = this;\n    if (isStatic) {} else {\n      // Bestow this mesh with animation superpowers and keeps track of its movements in the global animation queue\t\t\t\n      root.animationManager.unenroll(obj);\n    }\n  },\n  _addMethods: function (obj, isStatic) {\n    var root = this;\n    const labelName = \"label\";\n    const tooltipName = \"tooltip\";\n    const helpName = \"help\";\n    const shadowPlane = \"shadowPlane\";\n    if (isStatic) {} else {\n      if (!obj.coordinates) obj.coordinates = [0, 0, 0];\n\n      //[jscastro] added property for the internal 3D model\n      Object.defineProperty(obj, 'model', {\n        get() {\n          return obj.getObjectByName(\"model\");\n        }\n      });\n      let _animations;\n      //[jscastro] added property for the internal 3D model\n      Object.defineProperty(obj, 'animations', {\n        get() {\n          const model = obj.model;\n          if (model) {\n            return model.animations;\n          } else return null;\n        }\n        //set(value) { _animations = value}\n      });\n\n      // Bestow this mesh with animation superpowers and keeps track of its movements in the global animation queue\t\t\t\n      root.animationManager.enroll(obj);\n\n      // Place an object on the map at the given lnglat \n      obj.setCoords = function (lnglat) {\n        // CSS2DObjects could bring an specific vertical positioning to correct in units\n        if (obj.userData.topMargin && obj.userData.feature) {\n          lnglat[2] += ((obj.userData.feature.properties.height || 0) - (obj.userData.feature.properties.base_height || obj.userData.feature.properties.min_height || 0)) * (obj.userData.topMargin || 0);\n        }\n        obj.coordinates = lnglat;\n        obj.set({\n          position: lnglat\n        });\n        return obj;\n      };\n      obj.setTranslate = function (lnglat) {\n        obj.set({\n          translate: lnglat\n        });\n        return obj;\n      };\n      obj.setRotation = function (xyz) {\n        if (typeof xyz === 'number') xyz = {\n          z: xyz\n        };\n        var r = {\n          x: utils.radify(xyz.x) || obj.rotation.x,\n          y: utils.radify(xyz.y) || obj.rotation.y,\n          z: utils.radify(xyz.z) || obj.rotation.z\n        };\n        obj._setObject({\n          rotation: [r.x, r.y, r.z]\n        });\n      };\n\n      //[jscastro] added method to adjust 3D models to their issues with center position for rotation\n      obj.calculateAdjustedPosition = function (lnglat, xyz, inverse) {\n        let location = lnglat.slice();\n\n        //we convert the units to Long/Lat/Height\n        let newCoords = utils.unprojectFromWorld(obj.modelSize);\n        if (inverse) {\n          //each model will have different adjustment attributes, we add them for x, y, z\n          location[0] -= xyz.x != 0 ? newCoords[0] / xyz.x : 0;\n          location[1] -= xyz.y != 0 ? newCoords[1] / xyz.y : 0;\n          location[2] -= xyz.z != 0 ? newCoords[2] / xyz.z : 0;\n        } else {\n          //each model will have different adjustment attributes, we add them for x, y, z\n          location[0] += xyz.x != 0 ? newCoords[0] / xyz.x : 0;\n          location[1] += xyz.y != 0 ? newCoords[1] / xyz.y : 0;\n          location[2] += xyz.z != 0 ? newCoords[2] / xyz.z : 0;\n        }\n        return location;\n      };\n\n      //[jscastro] added method to rotate on objects on an axis instead of centers\n      obj.setRotationAxis = function (xyz) {\n        if (typeof xyz === 'number') xyz = {\n          z: xyz\n        };\n        let bb = obj.modelBox();\n        let point = new THREE.Vector3(bb.max.x, bb.max.y, bb.min.z);\n        //apply Axis rotation on angle\n        if (xyz.x != 0) _applyAxisAngle(obj, point, new THREE.Vector3(0, 0, 1), xyz.x);\n        if (xyz.y != 0) _applyAxisAngle(obj, point, new THREE.Vector3(0, 0, 1), xyz.y);\n        if (xyz.z != 0) _applyAxisAngle(obj, point, new THREE.Vector3(0, 0, 1), xyz.z);\n      };\n\n      //[jscastro] Auxiliar method to rotate an object on an axis\n      function _applyAxisAngle(model, point, axis, degrees) {\n        let theta = utils.radify(degrees);\n        model.position.sub(point); // remove the offset\n        model.position.applyAxisAngle(axis, theta); // rotate the POSITION\n        model.position.add(point); // re-add the offset\n        model.rotateOnAxis(axis, theta);\n        tb.map.repaint = true;\n      }\n\n      //[jscastro] added property for scaled group inside threeboxObject\n      Object.defineProperty(obj, 'scaleGroup', {\n        get() {\n          return obj.getObjectByName(\"scaleGroup\");\n        }\n      });\n\n      //[jscastro] added property for boundingBox group helper\n      Object.defineProperty(obj, 'boxGroup', {\n        get() {\n          return obj.getObjectByName(\"boxGroup\");\n        }\n      });\n\n      //[jscastro] added property for boundingBox helper\n      Object.defineProperty(obj, 'boundingBox', {\n        get() {\n          return obj.getObjectByName(\"boxModel\");\n        }\n      });\n      let _boundingBoxShadow;\n      //[jscastro] added property for boundingBox shadow helper\n      Object.defineProperty(obj, 'boundingBoxShadow', {\n        get() {\n          return obj.getObjectByName(\"boxShadow\");\n        }\n      });\n\n      //[jscastro] added method to create a bounding box and a shadow box\n      obj.drawBoundingBox = function () {\n        //let's create 2 wireframes, one for the object and one to project on the floor position\n        let bb = obj.box3();\n        //create the group to return\n        let boxGroup = new THREE.Group();\n        boxGroup.name = \"boxGroup\";\n        boxGroup.updateMatrixWorld(true);\n        let boxModel = new THREE.Box3Helper(bb, Objects.prototype._defaults.colors.yellow);\n        boxModel.name = \"boxModel\";\n        boxGroup.add(boxModel);\n        boxModel.layers.disable(0); // it makes the object invisible for the raycaster\n        //obj.boundingBox = boxModel;\n\n        //it needs to clone, to avoid changing the object by reference\n        let bb2 = bb.clone();\n        //we make the second box flat and at the floor height level\n        bb2.max.z = bb2.min.z;\n        let boxShadow = new THREE.Box3Helper(bb2, Objects.prototype._defaults.colors.black);\n        boxShadow.name = \"boxShadow\";\n        boxGroup.add(boxShadow);\n        boxShadow.layers.disable(0); // it makes the object invisible for the raycaster\n        //obj.boundingBoxShadow = boxShadow;\n\n        boxGroup.visible = false; // visibility is managed from the parent\n        obj.scaleGroup.add(boxGroup);\n        obj.setBoundingBoxShadowFloor();\n      };\n\n      //[jscastro] added method to position the shadow box on the floor depending the object height\n      obj.setBoundingBoxShadowFloor = function () {\n        if (obj.boundingBoxShadow) {\n          let h = -obj.modelHeight,\n            r = obj.rotation,\n            o = obj.boundingBoxShadow;\n          o.box.max.z = o.box.min.z = h;\n          o.rotation.y = r.y;\n          o.rotation.x = -r.x;\n        }\n      };\n\n      //[jscastro] Set the positional and pivotal anchor automatically from string param  \n      obj.setAnchor = function (anchor) {\n        const b = obj.box3();\n        //const size = b.getSize(new THREE.Vector3());\n        const c = b.getCenter(new THREE.Vector3());\n        obj.none = {\n          x: 0,\n          y: 0,\n          z: 0\n        };\n        obj.center = {\n          x: c.x,\n          y: c.y,\n          z: b.min.z\n        };\n        obj.bottom = {\n          x: c.x,\n          y: b.max.y,\n          z: b.min.z\n        };\n        obj.bottomLeft = {\n          x: b.max.x,\n          y: b.max.y,\n          z: b.min.z\n        };\n        obj.bottomRight = {\n          x: b.min.x,\n          y: b.max.y,\n          z: b.min.z\n        };\n        obj.top = {\n          x: c.x,\n          y: b.min.y,\n          z: b.min.z\n        };\n        obj.topLeft = {\n          x: b.max.x,\n          y: b.min.y,\n          z: b.min.z\n        };\n        obj.topRight = {\n          x: b.min.x,\n          y: b.min.y,\n          z: b.min.z\n        };\n        obj.left = {\n          x: b.max.x,\n          y: c.y,\n          z: b.min.z\n        };\n        obj.right = {\n          x: b.min.x,\n          y: c.y,\n          z: b.min.z\n        };\n        switch (anchor) {\n          case 'center':\n            obj.anchor = obj.center;\n            break;\n          case 'top':\n            obj.anchor = obj.top;\n            break;\n          case 'top-left':\n            obj.anchor = obj.topLeft;\n            break;\n          case 'top-right':\n            obj.anchor = obj.topRight;\n            break;\n          case 'left':\n            obj.anchor = obj.left;\n            break;\n          case 'right':\n            obj.anchor = obj.right;\n            break;\n          case 'bottom':\n            obj.anchor = obj.bottom;\n            break;\n          case 'bottom-left':\n          default:\n            obj.anchor = obj.bottomLeft;\n            break;\n          case 'bottom-right':\n            obj.anchor = obj.bottomRight;\n            break;\n          case 'auto':\n          case 'none':\n            obj.anchor = obj.none;\n        }\n        obj.model.position.set(-obj.anchor.x, -obj.anchor.y, -obj.anchor.z);\n      };\n\n      //[jscastro] Set the positional and pivotal anchor based on (x, y, z) size units\n      obj.setCenter = function (center) {\n        //[jscastro] if the object options have an adjustment to center the 3D Object different to 0\n        if (center && (center.x != 0 || center.y != 0 || center.z != 0)) {\n          let size = obj.getSize();\n          obj.anchor = {\n            x: obj.anchor.x - size.x * center.x,\n            y: obj.anchor.y - size.y * center.y,\n            z: obj.anchor.z - size.z * center.z\n          };\n          obj.model.position.set(-obj.anchor.x, -obj.anchor.y, -obj.anchor.z);\n        }\n      };\n\n      //[jscastro] added property for simulated label\n      Object.defineProperty(obj, 'label', {\n        get() {\n          return obj.getObjectByName(labelName);\n        }\n      });\n\n      //[jscastro] added property for simulated tooltip\n      Object.defineProperty(obj, 'tooltip', {\n        get() {\n          return obj.getObjectByName(tooltipName);\n        }\n      });\n\n      //[jscastro] added property for help\n      Object.defineProperty(obj, 'help', {\n        get() {\n          return obj.getObjectByName(helpName);\n        }\n      });\n      let _hidden = false;\n      //[jscastro] added property for explicitely hidden object to avoid zoom layer behavior\n      Object.defineProperty(obj, 'hidden', {\n        get() {\n          return _hidden;\n        },\n        set(value) {\n          if (_hidden != value) {\n            _hidden = value;\n            obj.visibility = !_hidden;\n          }\n        }\n      });\n\n      //[jscastro] added property to redefine visible, including the label and tooltip\n      Object.defineProperty(obj, 'visibility', {\n        get() {\n          return obj.visible;\n        },\n        set(value) {\n          let _value = value;\n          if (value == 'visible' || value == true) {\n            _value = true;\n            if (obj.label) obj.label.visible = _value;\n          } else if (value == 'none' || value == false) {\n            _value = false;\n            if (obj.label && obj.label.alwaysVisible) obj.label.visible = _value;\n            if (obj.tooltip) obj.tooltip.visible = _value;\n          } else return;\n          if (obj.visible != _value) {\n            if (obj.hidden && _value) return;\n            obj.visible = _value;\n            if (obj.model) {\n              obj.model.traverse(function (c) {\n                if (c.type == \"Mesh\" || c.type == \"SkinnedMesh\") {\n                  if (_value && obj.raycasted) {\n                    c.layers.enable(0); //this makes the meshes visible for raycast\n                  } else {\n                    c.layers.disable(0); //this makes the meshes invisible for raycast\n                  }\n                }\n                if (c.type == \"LineSegments\") {\n                  c.layers.disableAll();\n                }\n              });\n            }\n          }\n        }\n      });\n\n      //[jscastro] add CSS2 label method \n      obj.addLabel = function (HTMLElement, visible, center, height) {\n        if (HTMLElement) {\n          //we add it to the first children to get same boxing and position\n          //obj.children[0].add(obj.drawLabel(text, height));\n          obj.drawLabelHTML(HTMLElement, visible, center, height);\n        }\n      };\n\n      //[jscastro] remove CSS2 label method \n      obj.removeLabel = function () {\n        obj.removeCSS2D(labelName);\n      };\n\n      //[jscastro] draw label method can be invoked separately\n      obj.drawLabelHTML = function (HTMLElement, visible = false, center = obj.anchor, height = 0.5) {\n        let divLabel = root.drawLabelHTML(HTMLElement, Objects.prototype._defaults.label.cssClass);\n        let label = obj.addCSS2D(divLabel, labelName, center, height); //label.position.set(((-size.x * 0.5) - obj.model.position.x - center.x + bottomLeft.x), ((-size.y * 0.5) - obj.model.position.y - center.y + bottomLeft.y), size.z * 0.5); //middle-centered\n        label.alwaysVisible = visible;\n        label.visible = visible;\n        return label;\n      };\n\n      //[jscastro] add tooltip method \n      obj.addTooltip = function (tooltipText, mapboxStyle, center, custom = true, height = 1) {\n        let t = obj.addHelp(tooltipText, tooltipName, mapboxStyle, center, height);\n        t.visible = false;\n        t.custom = custom;\n      };\n\n      //[jscastro] remove CSS2 tooltip method\n      obj.removeTooltip = function () {\n        obj.removeCSS2D(tooltipName);\n      };\n\n      //[jscastro] add tooltip method \n      obj.addHelp = function (helpText, objName = helpName, mapboxStyle = false, center = obj.anchor, height = 0) {\n        let divHelp = root.drawTooltip(helpText, mapboxStyle);\n        let h = obj.addCSS2D(divHelp, objName, center, height);\n        h.visible = true;\n        return h;\n      };\n\n      //[jscastro] remove CSS2 tooltip method\n      obj.removeHelp = function () {\n        obj.removeCSS2D(helpName);\n      };\n\n      //[jscastro] add CSS2D help method \n      obj.addCSS2D = function (element, objName, center = obj.anchor, height = 1) {\n        if (element) {\n          const box = obj.box3();\n          const size = box.getSize(new THREE.Vector3());\n          let bottomLeft = {\n            x: box.max.x,\n            y: box.max.y,\n            z: box.min.z\n          };\n          obj.removeCSS2D(objName);\n          let c = new CSS2D.CSS2DObject(element);\n          c.name = objName;\n          c.position.set(-size.x * 0.5 - obj.model.position.x - center.x + bottomLeft.x, -size.y * 0.5 - obj.model.position.y - center.y + bottomLeft.y, size.z * height);\n          c.visible = false; //only visible on mouseover or selected\n          obj.scaleGroup.add(c);\n          return c;\n        }\n      };\n\n      //[jscastro] remove CSS2 help method\n      obj.removeCSS2D = function (objName) {\n        let css2D = obj.getObjectByName(objName);\n        if (css2D) {\n          css2D.dispose();\n          let g = obj.scaleGroup.children;\n          g.splice(g.indexOf(css2D), 1);\n        }\n      };\n\n      //[jscastro] added property for help\n      Object.defineProperty(obj, 'shadowPlane', {\n        get() {\n          return obj.getObjectByName(shadowPlane);\n        }\n      });\n      let _castShadow = false;\n      //[jscastro] added property for traverse an object to cast a shadow\n      Object.defineProperty(obj, 'castShadow', {\n        get() {\n          return _castShadow;\n        },\n        set(value) {\n          if (!obj.model || _castShadow === value) return;\n          obj.model.traverse(function (c) {\n            if (c.isMesh) c.castShadow = true;\n          });\n          if (value) {\n            // we add the shadow plane automatically \n            const s = obj.modelSize;\n            const sz = [s.x, s.y, s.z, obj.modelHeight];\n            const pSize = Math.max(...sz) * 10;\n            const pGeo = new THREE.PlaneBufferGeometry(pSize, pSize);\n            const pMat = new THREE.ShadowMaterial();\n            //const pMat = new THREE.MeshStandardMaterial({ color: 0x660000 });\n            pMat.opacity = 0.5;\n            let p = new THREE.Mesh(pGeo, pMat);\n            p.name = shadowPlane;\n            p.layers.enable(1);\n            p.layers.disable(0); // it makes the object invisible for the raycaster\n            p.receiveShadow = value;\n            obj.add(p);\n          } else {\n            // or we remove it \n            obj.traverse(function (c) {\n              if (c.isMesh && c.material instanceof THREE.ShadowMaterial) obj.remove(c);\n            });\n          }\n          _castShadow = value;\n        }\n      });\n\n      //[jscastro] added method to position the shadow box on the floor depending the object height\n      obj.setReceiveShadowFloor = function () {\n        if (obj.castShadow) {\n          let sp = obj.shadowPlane,\n            p = sp.position,\n            r = sp.rotation;\n          p.z = -obj.modelHeight;\n          r.y = obj.rotation.y;\n          r.x = -obj.rotation.x;\n          if (obj.userData.units === 'meters') {\n            const s = obj.modelSize;\n            const sz = [s.x, s.y, s.z, -p.z];\n            const ps = Math.max(...sz) * 10;\n            const sc = ps / sp.geometry.parameters.width;\n            sp.scale.set(sc, sc, sc);\n          }\n        }\n      };\n      let _receiveShadow = false;\n      //[jscastro] added property for traverse an object to receive a shadow\n      Object.defineProperty(obj, 'receiveShadow', {\n        get() {\n          return _receiveShadow;\n        },\n        set(value) {\n          if (!obj.model || _receiveShadow === value) return;\n          obj.model.traverse(function (c) {\n            if (c.isMesh) c.receiveShadow = true;\n          });\n          _receiveShadow = value;\n        }\n      });\n      let _wireframe = false;\n      //[jscastro] added property for wireframes state\n      Object.defineProperty(obj, 'wireframe', {\n        get() {\n          return _wireframe;\n        },\n        set(value) {\n          if (!obj.model || _wireframe === value) return;\n          obj.model.traverse(function (c) {\n            if (c.type == \"Mesh\" || c.type == \"SkinnedMesh\") {\n              let materials = [];\n              if (!Array.isArray(c.material)) {\n                materials.push(c.material);\n              } else {\n                materials = c.material;\n              }\n              let m = materials[0];\n              if (value) {\n                c.userData.materials = m;\n                c.material = m.clone();\n                c.material.wireframe = c.material.transparent = value;\n                c.material.opacity = 0.3;\n              } else {\n                c.material.dispose();\n                c.material = c.userData.materials;\n                c.userData.materials.dispose();\n                c.userData.materials = null;\n              }\n              if (value) {\n                c.layers.disable(0);\n                c.layers.enable(1);\n              } else {\n                c.layers.disable(1);\n                c.layers.enable(0);\n              }\n            }\n            if (c.type == \"LineSegments\") {\n              c.layers.disableAll();\n            }\n          });\n          _wireframe = value;\n          // Dispatch new event WireFramed\n          obj.dispatchEvent({\n            type: 'Wireframed',\n            detail: obj\n          });\n        }\n      });\n      let _color = null;\n      //[jscastro] added property for wireframes state\n      Object.defineProperty(obj, 'color', {\n        get() {\n          return _color;\n        },\n        set(value) {\n          if (!obj.model || _color === value) return;\n          obj.model.traverse(function (c) {\n            if (c.type == \"Mesh\" || c.type == \"SkinnedMesh\") {\n              let materials = [];\n              if (!Array.isArray(c.material)) {\n                materials.push(c.material);\n              } else {\n                materials = c.material;\n              }\n              let m = materials[0];\n              if (value) {\n                c.userData.materials = m;\n                c.material = new THREE.MeshStandardMaterial();\n                c.material.color.setHex(value);\n              } else {\n                c.material.dispose();\n                c.material = c.userData.materials;\n                c.userData.materials.dispose();\n                c.userData.materials = null;\n              }\n            }\n          });\n          _color = value;\n        }\n      });\n      let _selected = false;\n      //[jscastro] added property for selected state\n      Object.defineProperty(obj, 'selected', {\n        get() {\n          return _selected;\n        },\n        set(value) {\n          if (value) {\n            if (obj.userData.bbox && !obj.boundingBox) obj.drawBoundingBox();\n            if (obj.boxGroup) {\n              obj.boundingBox.material = Objects.prototype._defaults.materials.boxSelectedMaterial;\n              obj.boundingBox.parent.visible = true;\n              obj.boundingBox.layers.enable(1);\n              obj.boundingBoxShadow.layers.enable(1);\n            }\n            if (obj.label && !obj.label.alwaysVisible) obj.label.visible = true;\n          } else {\n            if (obj.boxGroup) {\n              obj.remove(obj.boxGroup); //remove the box group\n            }\n            if (obj.label && !obj.label.alwaysVisible) obj.label.visible = false;\n            obj.removeHelp();\n          }\n          if (obj.tooltip) obj.tooltip.visible = value;\n          //only fire the event if value is different\n          if (_selected != value) {\n            _selected = value;\n            // Dispatch new event SelectedChange\n            obj.dispatchEvent({\n              type: 'SelectedChange',\n              detail: obj\n            });\n          }\n        }\n      });\n      let _raycasted = true;\n      //[jscastro] added property for including/excluding an object from raycast\n      Object.defineProperty(obj, 'raycasted', {\n        get() {\n          return _raycasted;\n        },\n        set(value) {\n          if (!obj.model || _raycasted === value) return;\n          obj.model.traverse(function (c) {\n            if (c.type == \"Mesh\" || c.type == \"SkinnedMesh\") {\n              if (!value) {\n                c.layers.disable(0);\n                c.layers.enable(1);\n              } else {\n                c.layers.disable(1);\n                c.layers.enable(0);\n              }\n            }\n          });\n          _raycasted = value;\n        }\n      });\n      let _over = false;\n      //[jscastro] added property for over state\n      Object.defineProperty(obj, 'over', {\n        get() {\n          return _over;\n        },\n        set(value) {\n          if (value) {\n            if (!obj.selected) {\n              if (obj.userData.bbox && !obj.boundingBox) obj.drawBoundingBox();\n              if (obj.userData.tooltip && !obj.tooltip) obj.addTooltip(obj.uuid, true, obj.anchor, false);\n              if (obj.boxGroup) {\n                obj.boundingBox.material = Objects.prototype._defaults.materials.boxOverMaterial;\n                obj.boundingBox.parent.visible = true;\n                obj.boundingBox.layers.enable(1);\n                obj.boundingBoxShadow.layers.enable(1);\n              }\n            }\n            if (obj.label && !obj.label.alwaysVisible) {\n              obj.label.visible = true;\n            }\n            // Dispatch new event ObjectOver\n            obj.dispatchEvent({\n              type: 'ObjectMouseOver',\n              detail: obj\n            });\n          } else {\n            if (!obj.selected) {\n              if (obj.boxGroup) {\n                obj.remove(obj.boxGroup); //remove the box group\n                if (obj.tooltip && !obj.tooltip.custom) obj.removeTooltip();\n              }\n              if (obj.label && !obj.label.alwaysVisible) {\n                obj.label.visible = false;\n              }\n            }\n            // Dispatch new event ObjectOver\n            obj.dispatchEvent({\n              type: 'ObjectMouseOut',\n              detail: obj\n            });\n          }\n          if (obj.tooltip) obj.tooltip.visible = value || obj.selected;\n          _over = value;\n        }\n      });\n\n      //[jscastro] get the object model Box3 in runtime\n      obj.box3 = function () {\n        //update Matrix and MatrixWorld to avoid issues with transformations not full applied\n        obj.updateMatrix();\n        obj.updateMatrixWorld(true, true);\n        let bounds;\n        //clone also the model inside it's the one who keeps the real size\n        if (obj.model) {\n          //let's clone the object before manipulate it\n          let dup = obj.clone(true);\n          let model = obj.model.clone();\n          //get the size of the model because the object is translated and has boundingBoxShadow\n          bounds = new THREE.Box3().setFromObject(model);\n          //if the object has parent it's already in the added to world so it's scaled and it could be rotated\n          if (obj.parent) {\n            //first, we return the object to it's original position of rotation, extract rotation and apply inversed\n            let rm = new THREE.Matrix4();\n            let rmi = new THREE.Matrix4();\n            obj.matrix.extractRotation(rm);\n            rmi.copy(rm).invert();\n            dup.setRotationFromMatrix(rmi);\n            //now the object inside will give us a NAABB Non-Axes Aligned Bounding Box \n            bounds = new THREE.Box3().setFromObject(model);\n          }\n        }\n        return bounds;\n      };\n\n      //[jscastro] modelBox\n      obj.modelBox = function () {\n        return obj.box3();\n      };\n      obj.getSize = function () {\n        return obj.box3().getSize(new THREE.Vector3(0, 0, 0));\n      };\n\n      //[jscastro]\n      let _modelSize = false;\n      //[jscastro] added property for wireframes state\n      Object.defineProperty(obj, 'modelSize', {\n        get() {\n          _modelSize = obj.getSize();\n          return _modelSize;\n        },\n        set(value) {\n          if (_modelSize != value) {\n            _modelSize = value;\n          }\n        }\n      });\n\n      //[jscastro] added property to get modelHeight\n      Object.defineProperty(obj, 'modelHeight', {\n        get() {\n          let h = obj.coordinates[2] || 0;\n          if (obj.userData.units === 'scene') h *= obj.unitsPerMeter / obj.scale.x;\n          return h;\n        }\n      });\n\n      //[jscastro] added property to calculate the units per meter in a given latitude\n      //reduced to 7 decimals to avoid deviations on the size of the same object  \n      Object.defineProperty(obj, 'unitsPerMeter', {\n        get() {\n          return Number(utils.projectedUnitsPerMeter(obj.coordinates[1]).toFixed(7));\n        }\n      });\n      let _fixedZoom = null;\n      //[jscastro] added property to have a fixed scale for some objects\n      Object.defineProperty(obj, 'fixedZoom', {\n        get() {\n          return obj.userData.fixedZoom;\n        },\n        set(value) {\n          if (obj.userData.fixedZoom === value) return;\n          obj.userData.fixedZoom = value;\n          obj.userData.units = value ? 'scene' : 'meters';\n        }\n      });\n\n      //[jscastro] sets the scale of an object based fixedZoom\n      obj.setFixedZoom = function (scale) {\n        if (obj.fixedZoom != null && obj.fixedZoom != 0) {\n          if (!scale) scale = obj.userData.mapScale;\n          let s = zoomScale(obj.fixedZoom);\n          if (s > scale) {\n            let calc = s / scale;\n            obj.scale.set(calc, calc, calc);\n          } else {\n            obj.scale.set(1, 1, 1);\n          }\n        }\n      };\n\n      //[jscastro] sets the scale of an object based in the scale and fixedZoom\n      obj.setScale = function (scale) {\n        // scale the model so that its units are interpreted as meters at the given latitude\n        if (obj.userData.units != 'scene') {\n          let s = obj.unitsPerMeter;\n          obj.scale.set(s, s, s);\n        } else if (obj.fixedZoom) {\n          if (scale) obj.userData.mapScale = scale;\n          obj.setFixedZoom(obj.userData.mapScale); //apply fixed zoom\n        } else obj.scale.set(1, 1, 1);\n      };\n      function zoomScale(zoom) {\n        return Math.pow(2, zoom);\n      }\n\n      //[jscastro] sets the scale and shadows position of an object based in the scale\n      obj.setObjectScale = function (scale) {\n        obj.setScale(scale);\n        obj.setBoundingBoxShadowFloor();\n        obj.setReceiveShadowFloor();\n      };\n    }\n    obj.add = function (o) {\n      obj.scaleGroup.add(o);\n      o.position.z = obj.coordinates[2] ? -obj.coordinates[2] : 0;\n      return o;\n    };\n    obj.remove = function (o) {\n      if (!o) return;\n      o.traverse(m => {\n        //console.log('dispose geometry!')\n        if (m.geometry) m.geometry.dispose();\n        if (m.material) {\n          if (m.material.isMaterial) {\n            cleanMaterial(m.material);\n          } else {\n            // an array of materials\n            for (const material of m.material) cleanMaterial(material);\n          }\n        }\n        if (m.dispose) m.dispose();\n      });\n      obj.scaleGroup.remove(o);\n      tb.map.repaint = true;\n    };\n\n    //[jscastro] clone + assigning all the attributes\n    obj.duplicate = function (options) {\n      let dupe = obj.clone(true); //clone the whole threebox object\n      dupe.getObjectByName(\"model\").animations = obj.animations; //we must set this explicitly before addMethods\n      if (dupe.userData.feature) {\n        if (options && options.feature) dupe.userData.feature = options.feature;\n        dupe.userData.feature.properties.uuid = dupe.uuid;\n      }\n      root._addMethods(dupe); // add methods\n\n      if (!options || utils.equal(options.scale, obj.userData.scale)) {\n        //no options, no changes, just return the same object\n        dupe.copyAnchor(obj); // copy anchors\n        //[jscastro] we add by default a tooltip that can be overriden later or hide it with threebox `enableTooltips`\n        return dupe;\n      } else {\n        dupe.userData = options;\n        dupe.userData.isGeoGroup = true;\n        dupe.remove(dupe.boxGroup);\n        // [jscastro] rotate and scale the model\n        const r = utils.types.rotation(options.rotation, [0, 0, 0]);\n        const s = utils.types.scale(options.scale, [1, 1, 1]);\n        // [jscastro] reposition to 0,0,0\n        dupe.model.position.set(0, 0, 0);\n        // rotate and scale\n        dupe.model.rotation.set(r[0], r[1], r[2]);\n        dupe.model.scale.set(s[0], s[1], s[2]);\n        //[jscastro] calculate automatically the pivotal center of the object\n        dupe.setAnchor(options.anchor);\n        //[jscastro] override the center calculated if the object has adjustments\n        dupe.setCenter(options.adjustment);\n        return dupe;\n      }\n    };\n\n    //[jscastro] copy anchor values\n    obj.copyAnchor = function (o) {\n      obj.anchor = o.anchor;\n      obj.none = {\n        x: 0,\n        y: 0,\n        z: 0\n      };\n      obj.center = o.center;\n      obj.bottom = o.bottom;\n      obj.bottomLeft = o.bottomLeft;\n      obj.bottomRight = o.bottomRight;\n      obj.top = o.top;\n      obj.topLeft = o.topLeft;\n      obj.topRight = o.topRight;\n      obj.left = o.left;\n      obj.right = o.right;\n    };\n    obj.dispose = function () {\n      Objects.prototype.unenroll(obj);\n      obj.traverse(o => {\n        //don't dispose th object itself as it will be recursive\n        if (o.parent && o.parent.name == \"world\") return;\n        if (o.name === \"threeboxObject\") return;\n\n        //console.log('dispose geometry!')\n        if (o.geometry) o.geometry.dispose();\n        if (o.material) {\n          if (o.material.isMaterial) {\n            cleanMaterial(o.material);\n          } else {\n            // an array of materials\n            for (const material of o.material) cleanMaterial(material);\n          }\n        }\n        if (o.dispose) o.dispose();\n      });\n      obj.children = [];\n    };\n    const cleanMaterial = material => {\n      //console.log('dispose material!')\n      material.dispose();\n\n      // dispose textures\n      for (const key of Object.keys(material)) {\n        const value = material[key];\n        if (value && typeof value === 'object' && 'minFilter' in value) {\n          //console.log('dispose texture!')\n          value.dispose();\n        }\n      }\n      let m = material;\n      let md = m.map || m.alphaMap || m.aoMap || m.bumpMap || m.displacementMap || m.emissiveMap || m.envMap || m.lightMap || m.metalnessMap || m.normalMap || m.roughnessMap;\n      if (md) {\n        if (m.map) m.map.dispose();\n        if (m.alphaMap) m.alphaMap.dispose();\n        if (m.aoMap) m.aoMap.dispose();\n        if (m.bumpMap) m.bumpMap.dispose();\n        if (m.displacementMap) m.displacementMap.dispose();\n        if (m.emissiveMap) m.emissiveMap.dispose();\n        if (m.envMap) m.envMap.dispose();\n        if (m.lightMap) m.lightMap.dispose();\n        if (m.metalnessMap) m.metalnessMap.dispose();\n        if (m.normalMap) m.normalMap.dispose();\n        if (m.roughnessMap) m.roughnessMap.dispose();\n      }\n    };\n    return obj;\n  },\n  _makeGroup: function (obj, options) {\n    let projScaleGroup = new THREE.Group();\n    projScaleGroup.name = \"scaleGroup\";\n    projScaleGroup.add(obj);\n    var geoGroup = new THREE.Group();\n    geoGroup.userData = options || {};\n    geoGroup.userData.isGeoGroup = true;\n    if (geoGroup.userData.feature) {\n      geoGroup.userData.feature.properties.uuid = geoGroup.uuid;\n    }\n    var isArrayOfObjects = projScaleGroup.length;\n    if (isArrayOfObjects) for (o of projScaleGroup) geoGroup.add(o);else geoGroup.add(projScaleGroup);\n\n    //utils._flipMaterialSides(projScaleGroup);\n    geoGroup.name = \"threeboxObject\";\n    return geoGroup;\n  },\n  animationManager: new AnimationManager(),\n  //[jscastro] add tooltip method \n  drawTooltip: function (tooltipText, mapboxStyle = false) {\n    if (tooltipText) {\n      let divToolTip;\n      if (mapboxStyle) {\n        let divContent = document.createElement('div');\n        divContent.className = 'mapboxgl-popup-content';\n        let strong = document.createElement('strong');\n        strong.innerHTML = tooltipText;\n        divContent.appendChild(strong);\n        let tip = document.createElement('div');\n        tip.className = 'mapboxgl-popup-tip';\n        let div = document.createElement('div');\n        div.className = 'marker mapboxgl-popup-anchor-bottom';\n        div.appendChild(tip);\n        div.appendChild(divContent);\n        divToolTip = document.createElement('div');\n        divToolTip.className += 'label3D';\n        divToolTip.appendChild(div);\n      } else {\n        divToolTip = document.createElement('span');\n        divToolTip.className = this._defaults.tooltip.cssClass;\n        divToolTip.innerHTML = tooltipText;\n      }\n      return divToolTip;\n    }\n  },\n  //[jscastro] draw label method can be invoked separately\n  drawLabelHTML: function (HTMLElement, cssClass) {\n    let div = document.createElement('div');\n    div.className += cssClass;\n    // [jscastro] create a div [TODO] analize if must be moved\n    if (typeof HTMLElement == 'string') {\n      div.innerHTML = HTMLElement;\n    } else {\n      div.innerHTML = HTMLElement.outerHTML;\n    }\n    return div;\n  },\n  _defaults: {\n    colors: {\n      red: new THREE.Color(0xff0000),\n      yellow: new THREE.Color(0xffff00),\n      green: new THREE.Color(0x00ff00),\n      black: new THREE.Color(0x000000)\n    },\n    materials: {\n      boxNormalMaterial: new THREE.LineBasicMaterial({\n        color: new THREE.Color(0xff0000)\n      }),\n      boxOverMaterial: new THREE.LineBasicMaterial({\n        color: new THREE.Color(0xffff00)\n      }),\n      boxSelectedMaterial: new THREE.LineBasicMaterial({\n        color: new THREE.Color(0x00ff00)\n      })\n    },\n    line: {\n      geometry: null,\n      color: 'black',\n      width: 1,\n      opacity: 1\n    },\n    label: {\n      htmlElement: null,\n      cssClass: \" label3D\",\n      alwaysVisible: false,\n      topMargin: -0.5\n    },\n    tooltip: {\n      text: '',\n      cssClass: 'toolTip text-xs',\n      mapboxStyle: false,\n      topMargin: 0\n    },\n    sphere: {\n      position: [0, 0, 0],\n      radius: 1,\n      sides: 20,\n      units: 'scene',\n      material: 'MeshBasicMaterial',\n      anchor: 'bottom-left',\n      bbox: true,\n      tooltip: true,\n      raycasted: true\n    },\n    tube: {\n      geometry: null,\n      radius: 1,\n      sides: 6,\n      units: 'scene',\n      material: 'MeshBasicMaterial',\n      anchor: 'center',\n      bbox: true,\n      tooltip: true,\n      raycasted: true\n    },\n    loadObj: {\n      type: null,\n      obj: null,\n      units: 'scene',\n      scale: 1,\n      rotation: 0,\n      defaultAnimation: 0,\n      anchor: 'bottom-left',\n      bbox: true,\n      tooltip: true,\n      raycasted: true,\n      clone: true\n    },\n    Object3D: {\n      obj: null,\n      units: 'scene',\n      anchor: 'bottom-left',\n      bbox: true,\n      tooltip: true,\n      raycasted: true\n    },\n    extrusion: {\n      coordinates: [[[]]],\n      geometryOptions: {},\n      height: 100,\n      materials: new THREE.MeshPhongMaterial({\n        color: 0x660000,\n        side: THREE.DoubleSide\n      }),\n      scale: 1,\n      rotation: 0,\n      units: 'scene',\n      anchor: 'center',\n      bbox: true,\n      tooltip: true,\n      raycasted: true\n    }\n  },\n  geometries: {\n    line: ['LineString'],\n    tube: ['LineString'],\n    sphere: ['Point']\n  }\n};\nmodule.exports = exports = Objects;","map":{"version":3,"names":["utils","require","material","THREE","AnimationManager","CSS2D","Objects","prototype","line","obj","_validate","_defaults","straightProject","lnglatsToWorld","geometry","normalized","normalizeVertices","flattenedArray","flattenVectors","vertices","positions","Float32Array","BufferGeometry","setAttribute","BufferAttribute","LineBasicMaterial","color","linewidth","Line","options","position","copy","extrusion","unenroll","isStatic","root","animationManager","_addMethods","labelName","tooltipName","helpName","shadowPlane","coordinates","Object","defineProperty","get","getObjectByName","_animations","model","animations","enroll","setCoords","lnglat","userData","topMargin","feature","properties","height","base_height","min_height","set","setTranslate","translate","setRotation","xyz","z","r","x","radify","rotation","y","_setObject","calculateAdjustedPosition","inverse","location","slice","newCoords","unprojectFromWorld","modelSize","setRotationAxis","bb","modelBox","point","Vector3","max","min","_applyAxisAngle","axis","degrees","theta","sub","applyAxisAngle","add","rotateOnAxis","tb","map","repaint","_boundingBoxShadow","drawBoundingBox","box3","boxGroup","Group","name","updateMatrixWorld","boxModel","Box3Helper","colors","yellow","layers","disable","bb2","clone","boxShadow","black","visible","scaleGroup","setBoundingBoxShadowFloor","boundingBoxShadow","h","modelHeight","o","box","setAnchor","anchor","b","c","getCenter","none","center","bottom","bottomLeft","bottomRight","top","topLeft","topRight","left","right","setCenter","size","getSize","_hidden","value","visibility","_value","label","alwaysVisible","tooltip","hidden","traverse","type","raycasted","enable","disableAll","addLabel","HTMLElement","drawLabelHTML","removeLabel","removeCSS2D","divLabel","cssClass","addCSS2D","addTooltip","tooltipText","mapboxStyle","custom","t","addHelp","removeTooltip","helpText","objName","divHelp","drawTooltip","removeHelp","element","CSS2DObject","css2D","dispose","g","children","splice","indexOf","_castShadow","isMesh","castShadow","s","sz","pSize","Math","pGeo","PlaneBufferGeometry","pMat","ShadowMaterial","opacity","p","Mesh","receiveShadow","remove","setReceiveShadowFloor","sp","units","ps","sc","parameters","width","scale","_receiveShadow","_wireframe","materials","Array","isArray","push","m","wireframe","transparent","dispatchEvent","detail","_color","MeshStandardMaterial","setHex","_selected","bbox","boundingBox","boxSelectedMaterial","parent","_raycasted","_over","selected","uuid","boxOverMaterial","updateMatrix","bounds","dup","Box3","setFromObject","rm","Matrix4","rmi","matrix","extractRotation","invert","setRotationFromMatrix","_modelSize","unitsPerMeter","Number","projectedUnitsPerMeter","toFixed","_fixedZoom","fixedZoom","setFixedZoom","mapScale","zoomScale","calc","setScale","zoom","pow","setObjectScale","isMaterial","cleanMaterial","duplicate","dupe","equal","copyAnchor","isGeoGroup","types","adjustment","key","keys","md","alphaMap","aoMap","bumpMap","displacementMap","emissiveMap","envMap","lightMap","metalnessMap","normalMap","roughnessMap","_makeGroup","projScaleGroup","geoGroup","isArrayOfObjects","length","divToolTip","divContent","document","createElement","className","strong","innerHTML","appendChild","tip","div","outerHTML","red","Color","green","boxNormalMaterial","htmlElement","text","sphere","radius","sides","tube","loadObj","defaultAnimation","Object3D","geometryOptions","MeshPhongMaterial","side","DoubleSide","geometries","module","exports"],"sources":["/Users/mihailbaleev/Documents/GitHub/Lastochka_spraying/frontend/node_modules/threebox-plugin/src/objects/objects.js"],"sourcesContent":["/**\r\n * @author peterqliu / https://github.com/peterqliu\r\n * @author jscastro / https://github.com/jscastro76\r\n */\r\nconst utils = require(\"../utils/utils.js\");\r\nconst material = require(\"../utils/material.js\");\r\nconst THREE = require('../three.js');\r\nconst AnimationManager = require(\"../animation/AnimationManager.js\");\r\nconst CSS2D = require(\"./CSS2DRenderer.js\");\r\n\r\nfunction Objects(){\r\n\r\n}\r\n\r\nObjects.prototype = {\r\n\r\n\t// standard 1px line with gl\r\n\tline: function (obj) {\r\n\r\n\t\tobj = utils._validate(obj, this._defaults.line);\r\n\r\n\t\t//project to world and normalize\r\n\t\tvar straightProject = utils.lnglatsToWorld(obj.geometry);\r\n\t\tvar normalized = utils.normalizeVertices(straightProject);\r\n\r\n\t\t//flatten array for buffergeometry\r\n\t\tvar flattenedArray = utils.flattenVectors(normalized.vertices);\r\n\r\n\t\tvar positions = new Float32Array(flattenedArray); // 3 vertices per point\r\n\t\tvar geometry = new THREE.BufferGeometry();\r\n\t\tgeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));\r\n\r\n\t\t// material\r\n\t\tvar material = new THREE.LineBasicMaterial({ color: 0xff0000, linewidth: 21 });\r\n\t\tvar line = new THREE.Line(geometry, material);\r\n\r\n\t\tline.options = options || {};\r\n\t\tline.position.copy(normalized.position)\r\n\r\n\t\treturn line\r\n\t},\r\n\r\n\textrusion: function (options) {\r\n\r\n\t},\r\n\r\n\tunenroll: function (obj, isStatic) {\r\n\t\tvar root = this;\r\n\r\n\t\tif (isStatic) {\r\n\r\n\t\t}\r\n\r\n\t\telse {\r\n\t\t\t// Bestow this mesh with animation superpowers and keeps track of its movements in the global animation queue\t\t\t\r\n\t\t\troot.animationManager.unenroll(obj);\r\n\r\n\t\t}\r\n\r\n\t},\r\n\r\n\t_addMethods: function (obj, isStatic) {\r\n\r\n\t\tvar root = this;\r\n\t\tconst labelName = \"label\";\r\n\t\tconst tooltipName = \"tooltip\";\r\n\t\tconst helpName = \"help\";\r\n\t\tconst shadowPlane = \"shadowPlane\";\r\n\r\n\t\tif (isStatic) {\r\n\r\n\t\t}\r\n\r\n\t\telse {\r\n\t\t\t\r\n\t\t\tif (!obj.coordinates) obj.coordinates = [0, 0, 0];\r\n\r\n\t\t\t//[jscastro] added property for the internal 3D model\r\n\t\t\tObject.defineProperty(obj, 'model', {\r\n\t\t\t\tget() {\r\n\t\t\t\t\treturn obj.getObjectByName(\"model\");\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tlet _animations;\r\n\t\t\t//[jscastro] added property for the internal 3D model\r\n\t\t\tObject.defineProperty(obj, 'animations', {\r\n\t\t\t\tget() {\r\n\t\t\t\t\tconst model = obj.model;\r\n\t\t\t\t\tif (model) {\r\n\t\t\t\t\t\treturn model.animations\r\n\t\t\t\t\t} else return null;\r\n\t\t\t\t},\r\n\t\t\t\t//set(value) { _animations = value}\r\n\t\t\t});\r\n\r\n\t\t\t// Bestow this mesh with animation superpowers and keeps track of its movements in the global animation queue\t\t\t\r\n\t\t\troot.animationManager.enroll(obj);\r\n\r\n\t\t\t// Place an object on the map at the given lnglat \r\n\t\t\tobj.setCoords = function (lnglat) {\r\n\r\n\t\t\t\t// CSS2DObjects could bring an specific vertical positioning to correct in units\r\n\t\t\t\tif (obj.userData.topMargin && obj.userData.feature) {\r\n\t\t\t\t\tlnglat[2] += ((obj.userData.feature.properties.height || 0) - (obj.userData.feature.properties.base_height || obj.userData.feature.properties.min_height || 0)) * (obj.userData.topMargin || 0);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tobj.coordinates = lnglat;\r\n\t\t\t\tobj.set({ position: lnglat });\r\n\t\t\t\treturn obj;\r\n\r\n\t\t\t}\r\n\r\n\t\t\tobj.setTranslate = function (lnglat) {\r\n\r\n\t\t\t\tobj.set({ translate: lnglat });\r\n\t\t\t\treturn obj;\r\n\r\n\t\t\t}\r\n\r\n\t\t\tobj.setRotation = function (xyz) {\r\n\r\n\t\t\t\tif (typeof xyz === 'number') xyz = { z: xyz }\r\n\r\n\t\t\t\tvar r = {\r\n\t\t\t\t\tx: utils.radify(xyz.x) || obj.rotation.x,\r\n\t\t\t\t\ty: utils.radify(xyz.y) || obj.rotation.y,\r\n\t\t\t\t\tz: utils.radify(xyz.z) || obj.rotation.z\r\n\t\t\t\t}\r\n\r\n\t\t\t\tobj._setObject({ rotation: [r.x, r.y, r.z] })\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] added method to adjust 3D models to their issues with center position for rotation\r\n\t\t\tobj.calculateAdjustedPosition = function (lnglat, xyz, inverse) {\r\n\r\n\t\t\t\tlet location = lnglat.slice();\r\n\r\n\t\t\t\t//we convert the units to Long/Lat/Height\r\n\t\t\t\tlet newCoords = utils.unprojectFromWorld(obj.modelSize);\r\n\r\n\t\t\t\tif (inverse) {\r\n\t\t\t\t\t//each model will have different adjustment attributes, we add them for x, y, z\r\n\t\t\t\t\tlocation[0] -= (xyz.x != 0 ? (newCoords[0] / xyz.x) : 0);\r\n\t\t\t\t\tlocation[1] -= (xyz.y != 0 ? (newCoords[1] / xyz.y) : 0);\r\n\t\t\t\t\tlocation[2] -= (xyz.z != 0 ? (newCoords[2] / xyz.z) : 0);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t//each model will have different adjustment attributes, we add them for x, y, z\r\n\t\t\t\t\tlocation[0] += (xyz.x != 0 ? (newCoords[0] / xyz.x) : 0);\r\n\t\t\t\t\tlocation[1] += (xyz.y != 0 ? (newCoords[1] / xyz.y) : 0);\r\n\t\t\t\t\tlocation[2] += (xyz.z != 0 ? (newCoords[2] / xyz.z) : 0);\r\n\r\n\t\t\t\t}\r\n\t\t\t\treturn location;\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] added method to rotate on objects on an axis instead of centers\r\n\t\t\tobj.setRotationAxis = function (xyz) {\r\n\t\t\t\tif (typeof xyz === 'number') xyz = { z: xyz }\r\n\r\n\t\t\t\tlet bb = obj.modelBox();\r\n\r\n\t\t\t\tlet point = new THREE.Vector3(bb.max.x, bb.max.y, bb.min.z);\r\n\t\t\t\t//apply Axis rotation on angle\r\n\t\t\t\tif (xyz.x != 0) _applyAxisAngle(obj, point, new THREE.Vector3(0, 0, 1), xyz.x);\r\n\t\t\t\tif (xyz.y != 0) _applyAxisAngle(obj, point, new THREE.Vector3(0, 0, 1), xyz.y);\r\n\t\t\t\tif (xyz.z != 0) _applyAxisAngle(obj, point, new THREE.Vector3(0, 0, 1), xyz.z);\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] Auxiliar method to rotate an object on an axis\r\n\t\t\tfunction _applyAxisAngle(model, point, axis, degrees) {\r\n\t\t\t\tlet theta = utils.radify(degrees);\r\n\t\t\t\tmodel.position.sub(point); // remove the offset\r\n\t\t\t\tmodel.position.applyAxisAngle(axis, theta); // rotate the POSITION\r\n\t\t\t\tmodel.position.add(point); // re-add the offset\r\n\t\t\t\tmodel.rotateOnAxis(axis, theta)\r\n\r\n\t\t\t\ttb.map.repaint = true;\r\n\t\t\t}\r\n\r\n\r\n\t\t\t//[jscastro] added property for scaled group inside threeboxObject\r\n\t\t\tObject.defineProperty(obj, 'scaleGroup', {\r\n\t\t\t\tget() {\r\n\t\t\t\t\treturn obj.getObjectByName(\"scaleGroup\");\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\t\t\t//[jscastro] added property for boundingBox group helper\r\n\t\t\tObject.defineProperty(obj, 'boxGroup', {\r\n\t\t\t\tget() {\r\n\t\t\t\t\treturn obj.getObjectByName(\"boxGroup\");\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\t\t\t//[jscastro] added property for boundingBox helper\r\n\t\t\tObject.defineProperty(obj, 'boundingBox', {\r\n\t\t\t\tget() {\r\n\t\t\t\t\treturn obj.getObjectByName(\"boxModel\");\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\t\t\tlet _boundingBoxShadow;\r\n\t\t\t//[jscastro] added property for boundingBox shadow helper\r\n\t\t\tObject.defineProperty(obj, 'boundingBoxShadow', {\r\n\t\t\t\tget() {\r\n\t\t\t\t\treturn obj.getObjectByName(\"boxShadow\");\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\t\t\t//[jscastro] added method to create a bounding box and a shadow box\r\n\t\t\tobj.drawBoundingBox = function () {\r\n\t\t\t\t//let's create 2 wireframes, one for the object and one to project on the floor position\r\n\t\t\t\tlet bb = obj.box3();\r\n\t\t\t\t//create the group to return\r\n\t\t\t\tlet boxGroup = new THREE.Group();\r\n\t\t\t\tboxGroup.name = \"boxGroup\";\r\n\t\t\t\tboxGroup.updateMatrixWorld(true);\r\n\t\t\t\tlet boxModel = new THREE.Box3Helper(bb, Objects.prototype._defaults.colors.yellow);\r\n\t\t\t\tboxModel.name = \"boxModel\";\r\n\t\t\t\tboxGroup.add(boxModel);\r\n\t\t\t\tboxModel.layers.disable(0); // it makes the object invisible for the raycaster\r\n\t\t\t\t//obj.boundingBox = boxModel;\r\n\r\n\t\t\t\t//it needs to clone, to avoid changing the object by reference\r\n\t\t\t\tlet bb2 = bb.clone();\r\n\t\t\t\t//we make the second box flat and at the floor height level\r\n\t\t\t\tbb2.max.z = bb2.min.z;\r\n\t\t\t\tlet boxShadow = new THREE.Box3Helper(bb2, Objects.prototype._defaults.colors.black);\r\n\t\t\t\tboxShadow.name = \"boxShadow\";\r\n\r\n\t\t\t\tboxGroup.add(boxShadow);\r\n\t\t\t\tboxShadow.layers.disable(0); // it makes the object invisible for the raycaster\r\n\t\t\t\t//obj.boundingBoxShadow = boxShadow;\r\n\r\n\t\t\t\tboxGroup.visible = false; // visibility is managed from the parent\r\n\t\t\t\tobj.scaleGroup.add(boxGroup);\r\n\t\t\t\tobj.setBoundingBoxShadowFloor();\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] added method to position the shadow box on the floor depending the object height\r\n\t\t\tobj.setBoundingBoxShadowFloor = function () {\r\n\t\t\t\tif (obj.boundingBoxShadow) {\r\n\t\t\t\t\tlet h = -obj.modelHeight, r = obj.rotation, o = obj.boundingBoxShadow;\r\n\t\t\t\t\to.box.max.z = o.box.min.z = h;\r\n\t\t\t\t\to.rotation.y = r.y;\r\n\t\t\t\t\to.rotation.x = -r.x;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] Set the positional and pivotal anchor automatically from string param  \r\n\t\t\tobj.setAnchor = function (anchor) {\r\n\t\t\t\tconst b = obj.box3();\r\n\t\t\t\t//const size = b.getSize(new THREE.Vector3());\r\n\t\t\t\tconst c = b.getCenter(new THREE.Vector3());\r\n\t\t\t\tobj.none = { x: 0, y: 0, z: 0 };\r\n\t\t\t\tobj.center = { x: c.x, y: c.y, z: b.min.z };\r\n\t\t\t\tobj.bottom = { x: c.x, y: b.max.y, z: b.min.z };\r\n\t\t\t\tobj.bottomLeft = { x: b.max.x, y: b.max.y, z: b.min.z };\r\n\t\t\t\tobj.bottomRight = { x: b.min.x, y: b.max.y, z: b.min.z };\r\n\t\t\t\tobj.top = { x: c.x, y: b.min.y, z: b.min.z };\r\n\t\t\t\tobj.topLeft = { x: b.max.x, y: b.min.y, z: b.min.z };\r\n\t\t\t\tobj.topRight = { x: b.min.x, y: b.min.y, z: b.min.z };\r\n\t\t\t\tobj.left = { x: b.max.x, y: c.y, z: b.min.z };\r\n\t\t\t\tobj.right = { x: b.min.x, y: c.y, z: b.min.z };\r\n\r\n\t\t\t\tswitch (anchor) {\r\n\t\t\t\t\tcase 'center':\r\n\t\t\t\t\t\tobj.anchor = obj.center;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'top':\r\n\t\t\t\t\t\tobj.anchor = obj.top;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'top-left':\r\n\t\t\t\t\t\tobj.anchor = obj.topLeft;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'top-right':\r\n\t\t\t\t\t\tobj.anchor = obj.topRight;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'left':\r\n\t\t\t\t\t\tobj.anchor = obj.left;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'right':\r\n\t\t\t\t\t\tobj.anchor = obj.right;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'bottom':\r\n\t\t\t\t\t\tobj.anchor = obj.bottom;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'bottom-left':\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tobj.anchor = obj.bottomLeft;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'bottom-right':\r\n\t\t\t\t\t\tobj.anchor = obj.bottomRight;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'auto':\r\n\t\t\t\t\tcase 'none':\r\n\t\t\t\t\t\tobj.anchor = obj.none;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tobj.model.position.set(-obj.anchor.x, -obj.anchor.y, -obj.anchor.z);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] Set the positional and pivotal anchor based on (x, y, z) size units\r\n\t\t\tobj.setCenter = function (center) {\r\n\t\t\t\t//[jscastro] if the object options have an adjustment to center the 3D Object different to 0\r\n\t\t\t\tif (center && (center.x != 0 || center.y != 0 || center.z != 0)) {\r\n\t\t\t\t\tlet size = obj.getSize();\r\n\t\t\t\t\tobj.anchor = { x: obj.anchor.x - (size.x * center.x), y: obj.anchor.y - (size.y * center.y), z: obj.anchor.z - (size.z * center.z) };\r\n\t\t\t\t\tobj.model.position.set(-obj.anchor.x, -obj.anchor.y, -obj.anchor.z)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] added property for simulated label\r\n\t\t\tObject.defineProperty(obj, 'label', {\r\n\t\t\t\tget() { return obj.getObjectByName(labelName); }\r\n\t\t\t});\r\n\r\n\t\t\t//[jscastro] added property for simulated tooltip\r\n\t\t\tObject.defineProperty(obj, 'tooltip', {\r\n\t\t\t\tget() { return obj.getObjectByName(tooltipName); }\r\n\t\t\t});\r\n\r\n\t\t\t//[jscastro] added property for help\r\n\t\t\tObject.defineProperty(obj, 'help', {\r\n\t\t\t\tget() { return obj.getObjectByName(helpName); }\r\n\t\t\t});\r\n\r\n\t\t\tlet _hidden = false;\r\n\t\t\t//[jscastro] added property for explicitely hidden object to avoid zoom layer behavior\r\n\t\t\tObject.defineProperty(obj, 'hidden', {\r\n\t\t\t\tget() { return _hidden; },\r\n\t\t\t\tset(value) {\r\n\t\t\t\t\tif (_hidden != value) {\r\n\t\t\t\t\t\t_hidden = value;\r\n\t\t\t\t\t\tobj.visibility = !_hidden;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\t//[jscastro] added property to redefine visible, including the label and tooltip\r\n\t\t\tObject.defineProperty(obj, 'visibility', {\r\n\t\t\t\tget() { return obj.visible; },\r\n\t\t\t\tset(value) {\r\n\t\t\t\t\tlet _value = value;\r\n\t\t\t\t\tif (value == 'visible' || value == true) {\r\n\t\t\t\t\t\t_value = true;\r\n\t\t\t\t\t\tif (obj.label) obj.label.visible = _value;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (value == 'none' || value == false) {\r\n\t\t\t\t\t\t_value = false;\r\n\t\t\t\t\t\tif (obj.label && obj.label.alwaysVisible) obj.label.visible = _value;\r\n\t\t\t\t\t\tif (obj.tooltip) obj.tooltip.visible = _value;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse return;\r\n\t\t\t\t\tif (obj.visible != _value) {\r\n\t\t\t\t\t\tif (obj.hidden && _value) return;\r\n\r\n\t\t\t\t\t\tobj.visible = _value;\r\n\r\n\t\t\t\t\t\tif (obj.model) {\r\n\t\t\t\t\t\t\tobj.model.traverse(function (c) {\r\n\t\t\t\t\t\t\t\tif (c.type == \"Mesh\" || c.type == \"SkinnedMesh\") {\r\n\t\t\t\t\t\t\t\t\tif (_value && obj.raycasted) {\r\n\t\t\t\t\t\t\t\t\t\tc.layers.enable(0); //this makes the meshes visible for raycast\r\n\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\tc.layers.disable(0); //this makes the meshes invisible for raycast\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif (c.type == \"LineSegments\") {\r\n\t\t\t\t\t\t\t\t\tc.layers.disableAll();\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\t//[jscastro] add CSS2 label method \r\n\t\t\tobj.addLabel = function (HTMLElement, visible, center, height) {\r\n\t\t\t\tif (HTMLElement) {\r\n\t\t\t\t\t//we add it to the first children to get same boxing and position\r\n\t\t\t\t\t//obj.children[0].add(obj.drawLabel(text, height));\r\n\t\t\t\t\tobj.drawLabelHTML(HTMLElement, visible, center, height);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] remove CSS2 label method \r\n\t\t\tobj.removeLabel = function () {\r\n\t\t\t\tobj.removeCSS2D(labelName);\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] draw label method can be invoked separately\r\n\t\t\tobj.drawLabelHTML = function (HTMLElement, visible = false, center = obj.anchor, height = 0.5) {\r\n\t\t\t\tlet divLabel = root.drawLabelHTML(HTMLElement, Objects.prototype._defaults.label.cssClass);\r\n\t\t\t\tlet label = obj.addCSS2D(divLabel, labelName, center, height) //label.position.set(((-size.x * 0.5) - obj.model.position.x - center.x + bottomLeft.x), ((-size.y * 0.5) - obj.model.position.y - center.y + bottomLeft.y), size.z * 0.5); //middle-centered\r\n\t\t\t\tlabel.alwaysVisible = visible;\r\n\t\t\t\tlabel.visible = visible;\r\n\t\t\t\treturn label;\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] add tooltip method \r\n\t\t\tobj.addTooltip = function (tooltipText, mapboxStyle, center, custom = true, height = 1) {\r\n\t\t\t\tlet t = obj.addHelp(tooltipText, tooltipName, mapboxStyle, center, height);\r\n\t\t\t\tt.visible = false;\r\n\t\t\t\tt.custom = custom;\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] remove CSS2 tooltip method\r\n\t\t\tobj.removeTooltip = function () {\r\n\t\t\t\tobj.removeCSS2D(tooltipName);\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] add tooltip method \r\n\t\t\tobj.addHelp = function (helpText, objName = helpName, mapboxStyle = false, center = obj.anchor, height = 0) {\r\n\t\t\t\tlet divHelp = root.drawTooltip(helpText, mapboxStyle);\r\n\t\t\t\tlet h = obj.addCSS2D(divHelp, objName, center, height);\r\n\t\t\t\th.visible = true;\r\n\t\t\t\treturn h;\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] remove CSS2 tooltip method\r\n\t\t\tobj.removeHelp = function () {\r\n\t\t\t\tobj.removeCSS2D(helpName);\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] add CSS2D help method \r\n\t\t\tobj.addCSS2D = function (element, objName, center = obj.anchor, height = 1) {\r\n\t\t\t\tif (element) {\r\n\t\t\t\t\tconst box = obj.box3();\r\n\t\t\t\t\tconst size = box.getSize(new THREE.Vector3());\r\n\t\t\t\t\tlet bottomLeft = { x: box.max.x, y: box.max.y, z: box.min.z };\r\n\t\t\t\t\tobj.removeCSS2D(objName);\r\n\t\t\t\t\tlet c = new CSS2D.CSS2DObject(element);\r\n\t\t\t\t\tc.name = objName;\r\n\t\t\t\t\tc.position.set(((-size.x * 0.5) - obj.model.position.x - center.x + bottomLeft.x), ((-size.y * 0.5) - obj.model.position.y - center.y + bottomLeft.y), size.z * height); \r\n\t\t\t\t\tc.visible = false; //only visible on mouseover or selected\r\n\t\t\t\t\tobj.scaleGroup.add(c);\r\n\t\t\t\t\treturn c;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] remove CSS2 help method\r\n\t\t\tobj.removeCSS2D = function (objName) {\r\n\t\t\t\tlet css2D = obj.getObjectByName(objName);\r\n\t\t\t\tif (css2D) {\r\n\t\t\t\t\tcss2D.dispose();\r\n\t\t\t\t\tlet g = obj.scaleGroup.children;\r\n\t\t\t\t\tg.splice(g.indexOf(css2D), 1);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] added property for help\r\n\t\t\tObject.defineProperty(obj, 'shadowPlane', {\r\n\t\t\t\tget() { return obj.getObjectByName(shadowPlane); }\r\n\t\t\t});\r\n\r\n\t\t\tlet _castShadow = false;\r\n\t\t\t//[jscastro] added property for traverse an object to cast a shadow\r\n\t\t\tObject.defineProperty(obj, 'castShadow', {\r\n\t\t\t\tget() { return _castShadow; },\r\n\t\t\t\tset(value) {\r\n\t\t\t\t\tif (!obj.model || _castShadow === value) return;\r\n\r\n\t\t\t\t\tobj.model.traverse(function (c) {\r\n\t\t\t\t\t\tif (c.isMesh) c.castShadow = true;\r\n\t\t\t\t\t});\r\n\t\t\t\t\tif (value) {\r\n\t\t\t\t\t\t// we add the shadow plane automatically \r\n\t\t\t\t\t\tconst s = obj.modelSize;\r\n\t\t\t\t\t\tconst sz = [s.x, s.y, s.z, obj.modelHeight];\r\n\t\t\t\t\t\tconst pSize = Math.max(...sz) * 10;\r\n\t\t\t\t\t\tconst pGeo = new THREE.PlaneBufferGeometry(pSize, pSize);\r\n\t\t\t\t\t\tconst pMat = new THREE.ShadowMaterial();\r\n\t\t\t\t\t\t//const pMat = new THREE.MeshStandardMaterial({ color: 0x660000 });\r\n\t\t\t\t\t\tpMat.opacity = 0.5;\r\n\t\t\t\t\t\tlet p = new THREE.Mesh(pGeo, pMat);\r\n\t\t\t\t\t\tp.name = shadowPlane;\r\n\t\t\t\t\t\tp.layers.enable(1); p.layers.disable(0); // it makes the object invisible for the raycaster\r\n\t\t\t\t\t\tp.receiveShadow = value;\r\n\t\t\t\t\t\tobj.add(p);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// or we remove it \r\n\t\t\t\t\t\tobj.traverse(function (c) {\r\n\t\t\t\t\t\t\tif (c.isMesh && c.material instanceof THREE.ShadowMaterial)\r\n\t\t\t\t\t\t\t\tobj.remove(c);\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t\t_castShadow = value;\r\n\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\t\t\t//[jscastro] added method to position the shadow box on the floor depending the object height\r\n\t\t\tobj.setReceiveShadowFloor = function () {\r\n\t\t\t\tif (obj.castShadow) {\r\n\t\t\t\t\tlet sp = obj.shadowPlane, p = sp.position, r = sp.rotation;\r\n\t\t\t\t\tp.z = -obj.modelHeight;\r\n\t\t\t\t\tr.y = obj.rotation.y;\r\n\t\t\t\t\tr.x = -obj.rotation.x;\r\n\t\t\t\t\tif (obj.userData.units === 'meters') {\r\n\t\t\t\t\t\tconst s = obj.modelSize;\r\n\t\t\t\t\t\tconst sz = [s.x, s.y, s.z, -p.z];\r\n\t\t\t\t\t\tconst ps = Math.max(...sz) * 10;\r\n\t\t\t\t\t\tconst sc = ps / sp.geometry.parameters.width;\r\n\t\t\t\t\t\tsp.scale.set(sc, sc, sc);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tlet _receiveShadow = false;\r\n\t\t\t//[jscastro] added property for traverse an object to receive a shadow\r\n\t\t\tObject.defineProperty(obj, 'receiveShadow', {\r\n\t\t\t\tget() { return _receiveShadow; },\r\n\t\t\t\tset(value) {\r\n\t\t\t\t\tif (!obj.model || _receiveShadow === value) return;\r\n\t\t\t\t\tobj.model.traverse(function (c) {\r\n\t\t\t\t\t\tif (c.isMesh) c.receiveShadow = true;\r\n\t\t\t\t\t});\r\n\t\t\t\t\t_receiveShadow = value;\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\t\t\tlet _wireframe = false;\r\n\t\t\t//[jscastro] added property for wireframes state\r\n\t\t\tObject.defineProperty(obj, 'wireframe', {\r\n\t\t\t\tget() { return _wireframe; },\r\n\t\t\t\tset(value) {\r\n\t\t\t\t\tif (!obj.model || _wireframe === value) return;\r\n\t\t\t\t\tobj.model.traverse(function (c) {\r\n\t\t\t\t\t\tif (c.type == \"Mesh\" || c.type == \"SkinnedMesh\") {\r\n\t\t\t\t\t\t\tlet materials = [];\r\n\t\t\t\t\t\t\tif (!Array.isArray(c.material)) {\r\n\t\t\t\t\t\t\t\tmaterials.push(c.material);\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tmaterials = c.material;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tlet m = materials[0];\r\n\t\t\t\t\t\t\tif (value) {\r\n\t\t\t\t\t\t\t\tc.userData.materials = m;\r\n\t\t\t\t\t\t\t\tc.material = m.clone();\r\n\t\t\t\t\t\t\t\tc.material.wireframe = c.material.transparent = value;\r\n\t\t\t\t\t\t\t\tc.material.opacity = 0.3;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tc.material.dispose();\r\n\t\t\t\t\t\t\t\tc.material = c.userData.materials;\r\n\t\t\t\t\t\t\t\tc.userData.materials.dispose();\r\n\t\t\t\t\t\t\t\tc.userData.materials = null;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tif (value) { c.layers.disable(0); c.layers.enable(1); } else { c.layers.disable(1); c.layers.enable(0); }\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (c.type == \"LineSegments\") {\r\n\t\t\t\t\t\t\tc.layers.disableAll();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\t_wireframe = value;\r\n\t\t\t\t\t// Dispatch new event WireFramed\r\n\t\t\t\t\tobj.dispatchEvent({ type: 'Wireframed', detail: obj });\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\t\t\tlet _color = null;\r\n\t\t\t//[jscastro] added property for wireframes state\r\n\t\t\tObject.defineProperty(obj, 'color', {\r\n\t\t\t\tget() { return _color; },\r\n\t\t\t\tset(value) {\r\n\t\t\t\t\tif (!obj.model || _color === value) return;\r\n\t\t\t\t\tobj.model.traverse(function (c) {\r\n\t\t\t\t\t\tif (c.type == \"Mesh\" || c.type == \"SkinnedMesh\") {\r\n\t\t\t\t\t\t\tlet materials = [];\r\n\t\t\t\t\t\t\tif (!Array.isArray(c.material)) {\r\n\t\t\t\t\t\t\t\tmaterials.push(c.material);\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tmaterials = c.material;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tlet m = materials[0];\r\n\t\t\t\t\t\t\tif (value) {\r\n\t\t\t\t\t\t\t\tc.userData.materials = m;\r\n\t\t\t\t\t\t\t\tc.material = new THREE.MeshStandardMaterial();\r\n\t\t\t\t\t\t\t\tc.material.color.setHex(value);\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tc.material.dispose();\r\n\t\t\t\t\t\t\t\tc.material = c.userData.materials;\r\n\t\t\t\t\t\t\t\tc.userData.materials.dispose();\r\n\t\t\t\t\t\t\t\tc.userData.materials = null;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\t_color = value;\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\r\n\t\t\tlet _selected = false;\r\n\t\t\t//[jscastro] added property for selected state\r\n\t\t\tObject.defineProperty(obj, 'selected', {\r\n\t\t\t\tget() { return _selected; },\r\n\t\t\t\tset(value) {\r\n\t\t\t\t\tif (value) {\r\n\t\t\t\t\t\tif (obj.userData.bbox && !obj.boundingBox) obj.drawBoundingBox();\r\n\t\t\t\t\t\tif (obj.boxGroup) {\r\n\t\t\t\t\t\t\tobj.boundingBox.material = Objects.prototype._defaults.materials.boxSelectedMaterial;\r\n\t\t\t\t\t\t\tobj.boundingBox.parent.visible = true;\r\n\t\t\t\t\t\t\tobj.boundingBox.layers.enable(1);\r\n\t\t\t\t\t\t\tobj.boundingBoxShadow.layers.enable(1);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (obj.label && !obj.label.alwaysVisible) obj.label.visible = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tif (obj.boxGroup) {\r\n\t\t\t\t\t\t\tobj.remove(obj.boxGroup); //remove the box group\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (obj.label && !obj.label.alwaysVisible) obj.label.visible = false;\r\n\t\t\t\t\t\tobj.removeHelp();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (obj.tooltip) obj.tooltip.visible = value;\r\n\t\t\t\t\t//only fire the event if value is different\r\n\t\t\t\t\tif (_selected != value) {\r\n\t\t\t\t\t\t_selected = value;\r\n\t\t\t\t\t\t// Dispatch new event SelectedChange\r\n\t\t\t\t\t\tobj.dispatchEvent({ type: 'SelectedChange', detail: obj });\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\t\t\tlet _raycasted = true;\r\n\t\t\t//[jscastro] added property for including/excluding an object from raycast\r\n\t\t\tObject.defineProperty(obj, 'raycasted', {\r\n\t\t\t\tget() { return _raycasted; },\r\n\t\t\t\tset(value) {\r\n\t\t\t\t\tif (!obj.model || _raycasted === value) return;\r\n\t\t\t\t\tobj.model.traverse(function (c) {\r\n\t\t\t\t\t\tif (c.type == \"Mesh\" || c.type == \"SkinnedMesh\") {\r\n\t\t\t\t\t\t\tif (!value) { c.layers.disable(0); c.layers.enable(1); } else { c.layers.disable(1); c.layers.enable(0); }\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\t_raycasted = value;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tlet _over = false;\r\n\t\t\t//[jscastro] added property for over state\r\n\t\t\tObject.defineProperty(obj, 'over', {\r\n\t\t\t\tget() { return _over; },\r\n\t\t\t\tset(value) {\r\n\t\t\t\t\tif (value) {\r\n\t\t\t\t\t\tif (!obj.selected) {\r\n\t\t\t\t\t\t\tif (obj.userData.bbox && !obj.boundingBox) obj.drawBoundingBox();\r\n\t\t\t\t\t\t\tif (obj.userData.tooltip && !obj.tooltip) obj.addTooltip(obj.uuid, true, obj.anchor, false);\r\n\t\t\t\t\t\t\tif (obj.boxGroup) {\r\n\t\t\t\t\t\t\t\tobj.boundingBox.material = Objects.prototype._defaults.materials.boxOverMaterial;\r\n\t\t\t\t\t\t\t\tobj.boundingBox.parent.visible = true;\r\n\t\t\t\t\t\t\t\tobj.boundingBox.layers.enable(1);\r\n\t\t\t\t\t\t\t\tobj.boundingBoxShadow.layers.enable(1);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (obj.label && !obj.label.alwaysVisible) { obj.label.visible = true; }\r\n\t\t\t\t\t\t// Dispatch new event ObjectOver\r\n\t\t\t\t\t\tobj.dispatchEvent({ type: 'ObjectMouseOver', detail: obj });\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tif (!obj.selected) {\r\n\t\t\t\t\t\t\tif (obj.boxGroup) {\r\n\t\t\t\t\t\t\t\tobj.remove(obj.boxGroup); //remove the box group\r\n\t\t\t\t\t\t\t\tif (obj.tooltip && !obj.tooltip.custom) obj.removeTooltip();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (obj.label && !obj.label.alwaysVisible) { obj.label.visible = false; }\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// Dispatch new event ObjectOver\r\n\t\t\t\t\t\tobj.dispatchEvent({ type: 'ObjectMouseOut', detail: obj });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (obj.tooltip) obj.tooltip.visible = value || obj.selected;\r\n\t\t\t\t\t_over = value;\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\t\t\t//[jscastro] get the object model Box3 in runtime\r\n\t\t\tobj.box3 = function () {\r\n\t\t\t\t//update Matrix and MatrixWorld to avoid issues with transformations not full applied\r\n\t\t\t\tobj.updateMatrix();\r\n\t\t\t\tobj.updateMatrixWorld(true, true);\r\n\t\t\t\tlet bounds;\r\n\t\t\t\t//clone also the model inside it's the one who keeps the real size\r\n\t\t\t\tif (obj.model) {\r\n\t\t\t\t\t//let's clone the object before manipulate it\r\n\t\t\t\t\tlet dup = obj.clone(true);\r\n\t\t\t\t\tlet model = obj.model.clone();\r\n\t\t\t\t\t//get the size of the model because the object is translated and has boundingBoxShadow\r\n\t\t\t\t\tbounds = new THREE.Box3().setFromObject(model);\r\n\t\t\t\t\t//if the object has parent it's already in the added to world so it's scaled and it could be rotated\r\n\t\t\t\t\tif (obj.parent) {\r\n\t\t\t\t\t\t//first, we return the object to it's original position of rotation, extract rotation and apply inversed\r\n\t\t\t\t\t\tlet rm = new THREE.Matrix4();\r\n\t\t\t\t\t\tlet rmi = new THREE.Matrix4();\r\n\t\t\t\t\t\tobj.matrix.extractRotation(rm);\r\n\t\t\t\t\t\trmi.copy(rm).invert();\r\n\t\t\t\t\t\tdup.setRotationFromMatrix(rmi);\r\n\t\t\t\t\t\t//now the object inside will give us a NAABB Non-Axes Aligned Bounding Box \r\n\t\t\t\t\t\tbounds = new THREE.Box3().setFromObject(model);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn bounds;\r\n\t\t\t};\r\n\r\n\t\t\t//[jscastro] modelBox\r\n\t\t\tobj.modelBox = function () {\r\n\t\t\t\treturn obj.box3();\r\n\t\t\t}\r\n\r\n\t\t\tobj.getSize = function () {\r\n\t\t\t\treturn obj.box3().getSize(new THREE.Vector3(0, 0, 0));\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro]\r\n\t\t\tlet _modelSize = false;\r\n\t\t\t//[jscastro] added property for wireframes state\r\n\t\t\tObject.defineProperty(obj, 'modelSize', {\r\n\t\t\t\tget() {\r\n\t\t\t\t\t_modelSize = obj.getSize();\r\n\t\t\t\t\treturn _modelSize;\r\n\t\t\t\t},\r\n\t\t\t\tset(value) {\r\n\t\t\t\t\tif (_modelSize != value) {\r\n\t\t\t\t\t\t_modelSize = value;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\r\n\t\t\t//[jscastro] added property to get modelHeight\r\n\t\t\tObject.defineProperty(obj, 'modelHeight', {\r\n\t\t\t\tget() {\r\n\t\t\t\t\tlet h = obj.coordinates[2] || 0;\r\n\t\t\t\t\tif (obj.userData.units === 'scene') h *= (obj.unitsPerMeter / obj.scale.x);\r\n\t\t\t\t\treturn h;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\t//[jscastro] added property to calculate the units per meter in a given latitude\r\n\t\t\t//reduced to 7 decimals to avoid deviations on the size of the same object  \r\n\t\t\tObject.defineProperty(obj, 'unitsPerMeter', {\r\n\t\t\t\tget() { return Number(utils.projectedUnitsPerMeter(obj.coordinates[1]).toFixed(7)); }\r\n\t\t\t});\r\n\r\n\t\t\tlet _fixedZoom = null;\r\n\t\t\t//[jscastro] added property to have a fixed scale for some objects\r\n\t\t\tObject.defineProperty(obj, 'fixedZoom', {\r\n\t\t\t\tget() { return obj.userData.fixedZoom; },\r\n\t\t\t\tset(value) {\r\n\t\t\t\t\tif (obj.userData.fixedZoom === value) return;\r\n\t\t\t\t\tobj.userData.fixedZoom = value;\r\n\t\t\t\t\tobj.userData.units = (value ? 'scene' : 'meters');\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\t//[jscastro] sets the scale of an object based fixedZoom\r\n\t\t\tobj.setFixedZoom = function (scale) {\r\n\t\t\t\tif (obj.fixedZoom != null && obj.fixedZoom != 0) {\r\n\t\t\t\t\tif (!scale) scale = obj.userData.mapScale;\r\n\t\t\t\t\tlet s = zoomScale(obj.fixedZoom);\r\n\t\t\t\t\tif (s > scale) {\r\n\t\t\t\t\t\tlet calc = s / scale;\r\n\t\t\t\t\t\tobj.scale.set(calc, calc, calc);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tobj.scale.set(1, 1, 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t//[jscastro] sets the scale of an object based in the scale and fixedZoom\r\n\t\t\tobj.setScale = function (scale) {\r\n\t\t\t\t// scale the model so that its units are interpreted as meters at the given latitude\r\n\t\t\t\tif (obj.userData.units != 'scene') {\r\n\t\t\t\t\tlet s = obj.unitsPerMeter;\r\n\t\t\t\t\tobj.scale.set(s, s, s);\r\n\t\t\t\t} else if (obj.fixedZoom) {\r\n\t\t\t\t\tif (scale) obj.userData.mapScale = scale;\r\n\t\t\t\t\tobj.setFixedZoom(obj.userData.mapScale); //apply fixed zoom\r\n\t\t\t\t} else obj.scale.set(1, 1, 1);\r\n\t\t\t} \r\n\r\n\t\t\tfunction zoomScale(zoom) { return Math.pow(2, zoom); }\r\n\r\n\t\t\t//[jscastro] sets the scale and shadows position of an object based in the scale\r\n\t\t\tobj.setObjectScale = function (scale) {\r\n\t\t\t\tobj.setScale(scale);\r\n\t\t\t\tobj.setBoundingBoxShadowFloor();\r\n\t\t\t\tobj.setReceiveShadowFloor();\r\n\t\t\t} \r\n\r\n\t\t}\r\n\r\n\t\tobj.add = function (o) {\r\n\t\t\tobj.scaleGroup.add(o);\r\n\t\t\to.position.z = (obj.coordinates[2] ? -obj.coordinates[2] : 0);\r\n\t\t\treturn o;\r\n\t\t}\r\n\r\n\t\tobj.remove = function (o) {\r\n\t\t\tif (!o) return;\r\n\t\t\to.traverse(m => {\r\n\t\t\t\t//console.log('dispose geometry!')\r\n\t\t\t\tif (m.geometry) m.geometry.dispose();\r\n\t\t\t\tif (m.material) {\r\n\t\t\t\t\tif (m.material.isMaterial) {\r\n\t\t\t\t\t\tcleanMaterial(m.material)\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// an array of materials\r\n\t\t\t\t\t\tfor (const material of m.material) cleanMaterial(material)\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (m.dispose) m.dispose();\r\n\t\t\t})\r\n\r\n\t\t\tobj.scaleGroup.remove(o);\r\n\t\t\ttb.map.repaint = true;\r\n\t\t}\r\n\r\n\t\t//[jscastro] clone + assigning all the attributes\r\n\t\tobj.duplicate = function (options) {\r\n\r\n\t\t\tlet dupe = obj.clone(true);\t//clone the whole threebox object\r\n\t\t\tdupe.getObjectByName(\"model\").animations = obj.animations; //we must set this explicitly before addMethods\r\n\t\t\tif (dupe.userData.feature) {\r\n\t\t\t\tif (options && options.feature) dupe.userData.feature = options.feature;\r\n\t\t\t\tdupe.userData.feature.properties.uuid = dupe.uuid;\r\n\t\t\t}\r\n\t\t\troot._addMethods(dupe); // add methods\r\n\r\n\t\t\tif (!options || utils.equal(options.scale, obj.userData.scale)) {\r\n\t\t\t\t//no options, no changes, just return the same object\r\n\t\t\t\tdupe.copyAnchor(obj); // copy anchors\r\n\t\t\t\t//[jscastro] we add by default a tooltip that can be overriden later or hide it with threebox `enableTooltips`\r\n\t\t\t\treturn dupe;\r\n\t\t\t} else {\r\n\t\t\t\tdupe.userData = options;\r\n\t\t\t\tdupe.userData.isGeoGroup = true;\r\n\t\t\t\tdupe.remove(dupe.boxGroup);\r\n\t\t\t\t// [jscastro] rotate and scale the model\r\n\t\t\t\tconst r = utils.types.rotation(options.rotation, [0, 0, 0]);\r\n\t\t\t\tconst s = utils.types.scale(options.scale, [1, 1, 1]);\r\n\t\t\t\t// [jscastro] reposition to 0,0,0\r\n\t\t\t\tdupe.model.position.set(0, 0, 0);\r\n\t\t\t\t// rotate and scale\r\n\t\t\t\tdupe.model.rotation.set(r[0], r[1], r[2]);\r\n\t\t\t\tdupe.model.scale.set(s[0], s[1], s[2]);\r\n\t\t\t\t//[jscastro] calculate automatically the pivotal center of the object\r\n\t\t\t\tdupe.setAnchor(options.anchor);\r\n\t\t\t\t//[jscastro] override the center calculated if the object has adjustments\r\n\t\t\t\tdupe.setCenter(options.adjustment);\r\n\t\t\t\treturn dupe;\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t//[jscastro] copy anchor values\r\n\t\tobj.copyAnchor = function (o) {\r\n\r\n\t\t\tobj.anchor = o.anchor;\r\n\t\t\tobj.none = { x: 0, y: 0, z: 0 };\r\n\t\t\tobj.center = o.center;\r\n\t\t\tobj.bottom = o.bottom;\r\n\t\t\tobj.bottomLeft = o.bottomLeft;\r\n\t\t\tobj.bottomRight = o.bottomRight;\r\n\t\t\tobj.top = o.top;\r\n\t\t\tobj.topLeft = o.topLeft;\r\n\t\t\tobj.topRight = o.topRight;\r\n\t\t\tobj.left = o.left;\r\n\t\t\tobj.right = o.right;\r\n\r\n\t\t}\r\n\r\n\t\tobj.dispose = function () {\r\n\r\n\t\t\tObjects.prototype.unenroll(obj);\r\n\r\n\t\t\tobj.traverse(o => {\r\n\t\t\t\t//don't dispose th object itself as it will be recursive\r\n\t\t\t\tif (o.parent && o.parent.name == \"world\") return;\r\n\t\t\t\tif (o.name === \"threeboxObject\") return;\r\n\r\n\t\t\t\t//console.log('dispose geometry!')\r\n\t\t\t\tif (o.geometry) o.geometry.dispose();\r\n\r\n\t\t\t\tif (o.material) {\r\n\t\t\t\t\tif (o.material.isMaterial) {\r\n\t\t\t\t\t\tcleanMaterial(o.material)\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// an array of materials\r\n\t\t\t\t\t\tfor (const material of o.material) cleanMaterial(material)\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (o.dispose) o.dispose();\r\n\r\n\t\t\t})\r\n\r\n\t\t\tobj.children = [];\r\n\r\n\t\t}\r\n\r\n\t\tconst cleanMaterial = material => {\r\n\t\t\t//console.log('dispose material!')\r\n\t\t\tmaterial.dispose()\r\n\r\n\t\t\t// dispose textures\r\n\t\t\tfor (const key of Object.keys(material)) {\r\n\t\t\t\tconst value = material[key]\r\n\t\t\t\tif (value && typeof value === 'object' && 'minFilter' in value) {\r\n\t\t\t\t\t//console.log('dispose texture!')\r\n\t\t\t\t\tvalue.dispose()\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tlet m = material;\r\n\t\t\tlet md = (m.map || m.alphaMap || m.aoMap || m.bumpMap || m.displacementMap || m.emissiveMap || m.envMap || m.lightMap || m.metalnessMap || m.normalMap || m.roughnessMap)\r\n\t\t\tif (md) {\r\n\t\t\t\tif (m.map) m.map.dispose();\r\n\t\t\t\tif (m.alphaMap) m.alphaMap.dispose();\r\n\t\t\t\tif (m.aoMap) m.aoMap.dispose();\r\n\t\t\t\tif (m.bumpMap) m.bumpMap.dispose();\r\n\t\t\t\tif (m.displacementMap) m.displacementMap.dispose();\r\n\t\t\t\tif (m.emissiveMap) m.emissiveMap.dispose();\r\n\t\t\t\tif (m.envMap) m.envMap.dispose();\r\n\t\t\t\tif (m.lightMap) m.lightMap.dispose();\r\n\t\t\t\tif (m.metalnessMap) m.metalnessMap.dispose();\r\n\t\t\t\tif (m.normalMap) m.normalMap.dispose();\r\n\t\t\t\tif (m.roughnessMap) m.roughnessMap.dispose();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn obj\r\n\t},\r\n\r\n\t_makeGroup: function (obj, options) {\r\n\t\tlet projScaleGroup = new THREE.Group();\r\n\t\tprojScaleGroup.name = \"scaleGroup\";\r\n\t\tprojScaleGroup.add(obj)\r\n\r\n\t\tvar geoGroup = new THREE.Group();\r\n\t\tgeoGroup.userData = options || {};\r\n\t\tgeoGroup.userData.isGeoGroup = true;\r\n\t\tif (geoGroup.userData.feature) {\r\n\t\t\tgeoGroup.userData.feature.properties.uuid = geoGroup.uuid;\r\n\t\t}\r\n\t\tvar isArrayOfObjects = projScaleGroup.length;\r\n\t\tif (isArrayOfObjects) for (o of projScaleGroup) geoGroup.add(o)\r\n\t\telse geoGroup.add(projScaleGroup);\r\n\r\n\t\t//utils._flipMaterialSides(projScaleGroup);\r\n\t\tgeoGroup.name = \"threeboxObject\";\r\n\r\n\t\treturn geoGroup\r\n\t},\r\n\r\n\tanimationManager: new AnimationManager,\r\n\r\n\t//[jscastro] add tooltip method \r\n\tdrawTooltip : function (tooltipText, mapboxStyle = false) {\r\n\t\tif (tooltipText) {\r\n\t\t\tlet divToolTip;\r\n\t\t\tif (mapboxStyle) {\r\n\t\t\t\tlet divContent = document.createElement('div');\r\n\t\t\t\tdivContent.className = 'mapboxgl-popup-content';\r\n\t\t\t\tlet strong = document.createElement('strong');\r\n\t\t\t\tstrong.innerHTML = tooltipText;\r\n\t\t\t\tdivContent.appendChild(strong);\r\n\t\t\t\tlet tip = document.createElement('div');\r\n\t\t\t\ttip.className = 'mapboxgl-popup-tip';\r\n\t\t\t\tlet div = document.createElement('div');\r\n\t\t\t\tdiv.className = 'marker mapboxgl-popup-anchor-bottom';\r\n\t\t\t\tdiv.appendChild(tip);\r\n\t\t\t\tdiv.appendChild(divContent);\r\n\t\t\t\tdivToolTip = document.createElement('div');\r\n\t\t\t\tdivToolTip.className += 'label3D';\r\n\t\t\t\tdivToolTip.appendChild(div);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tdivToolTip = document.createElement('span');\r\n\t\t\t\tdivToolTip.className = this._defaults.tooltip.cssClass;\r\n\t\t\t\tdivToolTip.innerHTML = tooltipText;\r\n\t\t\t}\r\n\t\t\treturn divToolTip;\r\n\t\t}\r\n\t},\r\n\r\n\t//[jscastro] draw label method can be invoked separately\r\n\tdrawLabelHTML: function (HTMLElement, cssClass) {\r\n\t\tlet div = document.createElement('div');\r\n\t\tdiv.className += cssClass;\r\n\t\t// [jscastro] create a div [TODO] analize if must be moved\r\n\t\tif (typeof (HTMLElement) == 'string') {\r\n\t\t\tdiv.innerHTML = HTMLElement;\r\n\t\t} else {\r\n\t\t\tdiv.innerHTML = HTMLElement.outerHTML;\r\n\t\t}\r\n\t\treturn div;\r\n\t},\r\n\r\n\t_defaults: {\r\n\t\tcolors: {\r\n\t\t\tred: new THREE.Color(0xff0000),\r\n\t\t\tyellow: new THREE.Color(0xffff00),\r\n\t\t\tgreen: new THREE.Color(0x00ff00),\r\n\t\t\tblack: new THREE.Color(0x000000)\r\n\t\t},\r\n\r\n\t\tmaterials: {\r\n\t\t\tboxNormalMaterial: new THREE.LineBasicMaterial({ color: new THREE.Color(0xff0000) }),\r\n\t\t\tboxOverMaterial: new THREE.LineBasicMaterial({ color: new THREE.Color(0xffff00) }),\r\n\t\t\tboxSelectedMaterial: new THREE.LineBasicMaterial({ color: new THREE.Color(0x00ff00) })\r\n\t\t},\r\n\r\n\t\tline: {\r\n\t\t\tgeometry: null,\r\n\t\t\tcolor: 'black',\r\n\t\t\twidth: 1,\r\n\t\t\topacity: 1\r\n\t\t},\r\n\r\n\t\tlabel: {\r\n\t\t\thtmlElement: null,\r\n\t\t\tcssClass: \" label3D\",\r\n\t\t\talwaysVisible: false,\r\n\t\t\ttopMargin: -0.5\r\n\t\t},\r\n\r\n\t\ttooltip: {\r\n\t\t\ttext: '',\r\n\t\t\tcssClass: 'toolTip text-xs',\r\n\t\t\tmapboxStyle: false,\r\n\t\t\ttopMargin: 0\r\n\t\t},\r\n\r\n\t\tsphere: {\r\n\t\t\tposition: [0, 0, 0],\r\n\t\t\tradius: 1,\r\n\t\t\tsides: 20,\r\n\t\t\tunits: 'scene',\r\n\t\t\tmaterial: 'MeshBasicMaterial',\r\n\t\t\tanchor: 'bottom-left',\r\n\t\t\tbbox: true,\r\n\t\t\ttooltip: true,\r\n\t\t\traycasted: true\r\n\r\n\t\t},\r\n\r\n\t\ttube: {\r\n\t\t\tgeometry: null,\r\n\t\t\tradius: 1,\r\n\t\t\tsides: 6,\r\n\t\t\tunits: 'scene',\r\n\t\t\tmaterial: 'MeshBasicMaterial',\r\n\t\t\tanchor: 'center',\r\n\t\t\tbbox: true,\r\n\t\t\ttooltip: true,\r\n\t\t\traycasted: true\r\n\t\t},\r\n\r\n\t\tloadObj: {\r\n\t\t\ttype: null,\r\n\t\t\tobj: null,\r\n\t\t\tunits: 'scene',\r\n\t\t\tscale: 1,\r\n\t\t\trotation: 0,\r\n\t\t\tdefaultAnimation: 0,\r\n\t\t\tanchor: 'bottom-left',\r\n\t\t\tbbox: true,\r\n\t\t\ttooltip: true,\r\n\t\t\traycasted: true,\r\n\t\t\tclone: true\r\n\t\t},\r\n\r\n\t\tObject3D: {\r\n\t\t\tobj: null,\r\n\t\t\tunits: 'scene',\r\n\t\t\tanchor: 'bottom-left',\r\n\t\t\tbbox: true,\r\n\t\t\ttooltip: true, \r\n\t\t\traycasted: true\r\n\t\t},\r\n\r\n\t\textrusion: {\r\n\t\t\tcoordinates: [[[]]],\r\n\t\t\tgeometryOptions: {},\r\n\t\t\theight: 100,\r\n\t\t\tmaterials: new THREE.MeshPhongMaterial({ color: 0x660000, side: THREE.DoubleSide }),\r\n\t\t\tscale: 1,\r\n\t\t\trotation: 0,\r\n\t\t\tunits: 'scene',\r\n\t\t\tanchor: 'center',\r\n\t\t\tbbox: true,\r\n\t\t\ttooltip: true,\r\n\t\t\traycasted: true\r\n\r\n\t\t}\r\n\t},\r\n\r\n\tgeometries: {\r\n\t\tline: ['LineString'],\r\n\t\ttube: ['LineString'],\r\n\t\tsphere: ['Point'],\r\n\t}\r\n}\r\n\r\nmodule.exports = exports = Objects;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}