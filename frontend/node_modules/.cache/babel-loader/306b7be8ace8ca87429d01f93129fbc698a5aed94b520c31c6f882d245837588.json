{"ast":null,"code":"import takeoff_marker from \"./img/takeoff_marker.png\";\nimport point_marker from \"./img/point_marker.png\";\nimport icon_center from \"./img/icon_center.png\";\nimport mapboxgl from 'mapbox-gl';\nimport { SprayManager3d } from \"./manager3D\";\nimport { center } from \"@turf/turf\";\nfunction rotateFigureCenter(cords, center, phi) {\n  phi = phi * Math.PI / 180;\n  let rotatedFigure = [];\n  for (let pair of cords) {\n    let x = pair[0] - center[0];\n    let y = pair[1] - center[1];\n    let x_rot = x * Math.cos(phi) - y * Math.sin(phi);\n    let y_rot = x * Math.sin(phi) + y * Math.cos(phi);\n    rotatedFigure.push([x_rot + center[0], y_rot + center[1]]);\n  }\n  return rotatedFigure;\n}\nfunction addTurnaroundDistance(cords, distance, direction) {\n  let turnaround_distance_y = getGeoCordsFromMeters(distance, cords[1]);\n  let cortej = [];\n  if (direction == true) {\n    cortej = [cords[0], cords[1] + turnaround_distance_y];\n  } else {\n    cortej = [cords[0], cords[1] - turnaround_distance_y];\n  }\n  return cortej;\n}\nfunction getProjective(cords) {\n  let x = cords.map(x => x[0]);\n  let y = cords.map(x => x[1]);\n  let x_projection = {\n    min: 0,\n    max: 0,\n    pr: 0\n  };\n  let y_projection = {\n    min: 0,\n    max: 0,\n    pr: 0\n  };\n  x_projection.min = Math.min(...x);\n  x_projection.max = Math.max(...x);\n  x_projection.pr = x_projection.max - x_projection.min;\n  y_projection.min = Math.min(...y);\n  y_projection.max = Math.max(...y);\n  y_projection.pr = y_projection.max - y_projection.min;\n  return {\n    x_pr: x_projection,\n    y_pr: y_projection\n  };\n}\nfunction getGeoCordsFromMeters(m, min_lng) {\n  let step = m / 1000;\n  const km_ekv = 40075.696 / 360;\n  let step_deg = step / (km_ekv * Math.cos(Math.PI * min_lng / 180));\n  return step_deg;\n}\nexport class MapManager {\n  constructor(map, manager3D, update_modal_message, default_) {\n    this.map = map;\n    this.manager3D = new SprayManager3d(manager3D);\n    this.translate_cursor = false;\n    this.start_marker = null;\n    this.update_modal_message = update_modal_message;\n    this.last_id = 0;\n    this.params = {\n      angle: 0,\n      line_distance: 3,\n      turnaround_distance: 0,\n      reverse: false,\n      is_rtl: true,\n      alt: 3.5,\n      wind_speed: 2,\n      wind_direction: \"N\"\n    };\n    this.conture = {\n      markers: [],\n      cords: [],\n      edges: [],\n      source: {\n        'type': 'geojson',\n        'data': {\n          'type': 'Feature',\n          'geometry': {\n            'type': 'Polygon',\n            'coordinates': [[]]\n          }\n        }\n      },\n      layer_area: {\n        'id': \"area_conture\",\n        'type': 'fill',\n        'source': \"conture\",\n        'layout': {},\n        'paint': {\n          'fill-color': '#008000',\n          'fill-opacity': 0.5\n        }\n      },\n      layer_line: {\n        'id': 'line_conture',\n        'type': 'line',\n        'source': \"conture\",\n        'layout': {},\n        'paint': {\n          'line-color': '#000',\n          'line-width': 2\n        }\n      }\n    };\n    this.markup = {\n      cords: [],\n      source: {\n        'type': 'geojson',\n        'data': {\n          'type': 'Feature',\n          'geometry': {\n            'type': 'LineString',\n            'coordinates': [[]]\n          }\n        }\n      },\n      layer: {\n        'id': \"markup\",\n        'type': 'line',\n        'source': \"markup\",\n        'layout': {},\n        'paint': {\n          'line-color': '#fff',\n          'line-width': 2\n        }\n      }\n    };\n  }\n  calcPerpendVector(lat1, lon1, lat2, lon2) {\n    let dx = lon2 - lon1;\n    let dy = lat2 - lat1;\n    let perpDx = -dy;\n    let perpDy = dx;\n    let length = Math.sqrt(perpDx * perpDx + perpDy * perpDy);\n    perpDx /= length;\n    perpDy /= length;\n    return {\n      perpDx,\n      perpDy\n    };\n  }\n  meters2degrees(meters, lat) {\n    let degreesPerMeter = 1 / (111320 * Math.cos(lat * Math.PI / 180));\n    return meters * degreesPerMeter;\n  }\n  getRealSpray(is_update) {\n    let stripPoints = [];\n    let base_width = 2 * Math.tan(120);\n    let width = 2 * this.params.alt * Math.tan(120);\n    let opacity = base_width / width <= 1 ? base_width / width : 1;\n    if (width >= this.params.line_distance * 1.13) {\n      width = this.params.line_distance * 1.13;\n    }\n    for (let i = 0; i < this.markup.cords.length - 1; i++) {\n      let [lat1, lon1] = this.markup.cords[i];\n      let [lat2, lon2] = this.markup.cords[i + 1];\n      let {\n        perpDx,\n        perpDy\n      } = this.calcPerpendVector(lat1, lon1, lat2, lon2);\n      let halfWidthDegrees = this.meters2degrees(width / 2, lat1);\n      let leftLat1 = lat1 + perpDy * halfWidthDegrees;\n      let leftLon1 = lon1 + perpDx * halfWidthDegrees;\n      let rightLat1 = lat1 - perpDy * halfWidthDegrees;\n      let rightLon1 = lon1 - perpDx * halfWidthDegrees;\n      let leftLat2 = lat2 + perpDy * halfWidthDegrees;\n      let leftLon2 = lon2 + perpDx * halfWidthDegrees;\n      let rightLat2 = lat2 - perpDy * halfWidthDegrees;\n      let rightLon2 = lon2 - perpDx * halfWidthDegrees;\n      stripPoints.push({\n        left_first: [leftLat1, leftLon1],\n        left_second: [leftLat2, leftLon2],\n        right_first: [rightLat1, rightLon1],\n        right_second: [rightLat2, rightLon2]\n      });\n    }\n    let real_spray = [];\n    stripPoints.forEach(item => {\n      real_spray.push(item.left_first);\n      real_spray.push(item.left_second);\n    });\n    stripPoints.reverse().forEach(item => {\n      real_spray.push(item.right_second);\n      real_spray.push(item.right_first);\n    });\n    let shift_real_spray = this.getShift(real_spray);\n    if (is_update === true) {\n      let geojson = {\n        \"type\": \"FeatureCollection\",\n        \"features\": [{\n          \"type\": \"Feature\",\n          \"properties\": {\n            \"name\": \"sector\"\n          },\n          \"geometry\": {\n            \"type\": \"Polygon\",\n            \"coordinates\": [shift_real_spray]\n          }\n        }]\n      };\n      this.map.getSource(\"real_spray\").setData(geojson);\n      this.map.setPaintProperty(\"real_spray_layer\", \"fill-opacity\", opacity);\n    } else {\n      if (this.map.getSource(\"real_spray\")) {\n        this.map.removeLayer(\"real_spray_layer\");\n        this.map.removeSource(\"real_spray\");\n      }\n      let geojson = {\n        \"type\": \"geojson\",\n        \"data\": {\n          \"type\": \"FeatureCollection\",\n          \"features\": [{\n            \"type\": \"Feature\",\n            \"geometry\": {\n              \"type\": \"Polygon\",\n              \"coordinates\": [shift_real_spray]\n            }\n          }]\n        }\n      };\n      this.map.addSource(\"real_spray\", geojson);\n      this.map.addLayer({\n        \"id\": \"real_spray_layer\",\n        \"type\": \"fill\",\n        \"source\": \"real_spray\",\n        \"layout\": {},\n        \"paint\": {\n          \"fill-color\": \"#02d402\",\n          \"fill-opacity\": opacity\n        }\n      });\n    }\n  }\n  getShift(base_coords) {\n    const directions = {\n      \"N\": [0, -1],\n      \"NE\": [-Math.sqrt(2) / 2, -Math.sqrt(2) / 2],\n      \"E\": [-1, 0],\n      \"SE\": [-Math.sqrt(2) / 2, Math.sqrt(2) / 2],\n      \"S\": [0, 1],\n      \"SW\": [Math.sqrt(2) / 2, Math.sqrt(2) / 2],\n      \"W\": [1, 0],\n      \"NW\": [Math.sqrt(2) / 2, -Math.sqrt(2) / 2]\n    };\n    const radius = 6378160;\n    let wind_speed = Number(this.params.wind_speed);\n    let alt = Number(this.params.alt);\n    let wind_direction = directions[this.params.wind_direction];\n    let coord_arr = [];\n    base_coords.forEach(coord => {\n      let coord_x = coord[0];\n      let coord_y = coord[1];\n      let delta_x = 100 * wind_speed * Math.sqrt(2 * alt / 9.81) * wind_direction[0];\n      let delta_y = 100 * wind_speed * Math.sqrt(2 * alt / 9.81) * wind_direction[1];\n      let new_coord_x = coord_x + delta_x / radius;\n      let new_coord_y = coord_y + delta_y / radius;\n      coord_arr.push([new_coord_x, new_coord_y]);\n    });\n    return coord_arr;\n  }\n  getZoneShift() {\n    let conture = [];\n    this.conture.markers.forEach(marker => {\n      conture.push([marker.getLngLat().lng, marker.getLngLat().lat]);\n    });\n    let coord_arr = this.getShift(conture);\n    if (this.conture.markers.length >= 3) {\n      this.getRealSpray(true);\n      this.manager3D.drawShiftPolygon(coord_arr);\n    }\n  }\n  toggleCursor() {\n    if (this.translate_cursor === true) {\n      this.translate_cursor = false;\n    } else {\n      this.translate_cursor = true;\n    }\n  }\n  setStartMarker(coords) {\n    if (this.start_marker === null) {\n      this.start_marker = new mapboxgl.Marker({\n        draggable: false\n      }).setLngLat(coords).addTo(this.map);\n      let icon = document.createElement('img');\n      icon.src = takeoff_marker;\n      icon.width = 35;\n      icon.height = 35;\n      this.start_marker.getElement().querySelector(\"svg\").remove();\n      this.start_marker.getElement().append(icon);\n      let indicator = document.createElement('span');\n      indicator.className = \"mapbox_gl_active_indicator\";\n      this.start_marker.getElement().append(indicator);\n      this.start_marker.getElement().classList.add(\"takeoff\");\n      this.manager3D.addSphere([coords[0], coords[1], 0], 0);\n      this.last_id += 1;\n    } else {\n      this.start_marker.remove();\n      this.start_marker = null;\n      this.setStartMarker(coords);\n      this.manager3D.deleteObject(0);\n      this.manager3D.addSphere([coords[0], coords[1], 0], 0);\n    }\n    this.updateRouteLine();\n  }\n  changeMarkerIcon(marker, Icon, width, height) {\n    let icon = document.createElement('img');\n    icon.src = Icon;\n    icon.width = width;\n    icon.height = height;\n    marker.getElement().classList.add(\"mapboxgl-marker__polygon\");\n    marker.getElement().querySelector(\"svg\").remove();\n    marker.getElement().append(icon);\n    let indicator = document.createElement('span');\n    indicator.className = \"mapbox_gl_active_indicator\";\n    marker.getElement().append(indicator);\n  }\n  rotatePolygon(angle) {\n    ///real rotate\n    this.params.angle = Number(angle);\n    if (this.conture.cords.length != 0) {\n      this.updateCenterMarker();\n      this.updateMarkup();\n      this.getRealSpray(true);\n    }\n  }\n  changeLineSpacing(dist) {\n    this.params.line_distance = Number(dist);\n    if (this.conture.cords.length != 0) {\n      this.updateCenterMarker();\n      this.updateMarkup();\n      this.getRealSpray(true);\n    }\n  }\n  toggleRTL() {\n    if (this.params.is_rtl === true) {\n      this.params.is_rtl = false;\n    } else {\n      this.params.is_rtl = true;\n    }\n    if (this.conture.markers.length != 0) {\n      this.updateCenterMarker();\n      this.updateMarkup();\n    }\n  }\n  changeAlt(alt) {\n    this.params.alt = Number(alt);\n    if (this.conture.cords.length != 0) {\n      this.updateCenterMarker();\n      this.updateMarkup();\n      this.conture.markers.forEach(marker => {\n        this.manager3D.changeCoords(marker.id, [marker.getLngLat().lng, marker.getLngLat().lat, this.params.alt]);\n      });\n      this.getRealSpray(true);\n    }\n  }\n  changeWind(key, value) {\n    this.params[key] = value;\n    this.getZoneShift();\n  }\n  markupPolygon() {\n    let edges = [];\n    let cords_markup = this.rotate(this.conture.cords, 1);\n    for (let c = 0; c < this.conture.cords.length - 1; c++) {\n      edges.push([cords_markup[c], cords_markup[c + 1]]);\n    }\n    let pr = getProjective(cords_markup);\n    let step = getGeoCordsFromMeters(this.params.line_distance, pr.y_pr.min);\n    let steps = Math.trunc(pr.x_pr.pr / step);\n    let cords = [];\n    for (let i = 0; i < steps; i++) {\n      let x_0 = pr.x_pr.min + step * (i + 1);\n      let crossings = [];\n      let low = [1000, null];\n      let high = [-1000, null];\n      for (let j = 0; j < edges.length; j++) {\n        let A = edges[j][0];\n        let B = edges[j][1];\n        let y = (B[1] - A[1]) * (x_0 - B[0]) / (B[0] - A[0]) + B[1];\n        let min_y = Math.min(A[1], B[1]);\n        let max_y = Math.max(A[1], B[1]);\n        if (y > min_y && y < max_y) {\n          if (y > high[0]) {\n            high[0] = y;\n            high[1] = [x_0, y];\n          } else if (y < low[0]) {\n            low[0] = y;\n            low[1] = [x_0, y];\n          }\n          crossings.push([x_0, y]);\n        }\n      }\n      crossings = crossings.sort(function (a, b) {\n        return a[1] - b[1];\n      });\n      low[1] = crossings[0];\n      high[1] = crossings[crossings.length - 1];\n      low[1] = addTurnaroundDistance(low[1], this.params.turnaround_distance, false);\n      high[1] = addTurnaroundDistance(high[1], this.params.turnaround_distance, true);\n      if ((cords.length + 2) % 4 == 0) {\n        cords.push(low[1]);\n        cords.push(high[1]);\n      } else {\n        cords.push(high[1]);\n        cords.push(low[1]);\n      }\n    }\n    cords = this.rotate(cords, -1);\n    if (cords.length == 0) {\n      return this.conture.cords;\n    } else {\n      cords = cords.map(cord => {\n        return [cord[0], cord[1], this.params.alt];\n      });\n      return cords;\n    }\n  }\n  addConturePoint(coords) {\n    let cords = coords;\n    let marker = new mapboxgl.Marker({\n      draggable: true\n    }).setLngLat(cords).addTo(this.map);\n    marker.conture_index = this.conture.markers.length;\n    marker.id = this.last_id;\n    this.conture.markers.push(marker);\n    let dragContainer = e => {\n      e.marker = marker;\n      e.evt = {};\n      e.id = marker.id;\n      this.drag(e);\n    };\n    let dragEndContainer = e => {\n      e.evt = {};\n      this.dragEndCont(e);\n    };\n    let dragStartContainer = e => {\n      e.evt = {};\n      this.dragStartCont(e);\n    };\n    marker.on(\"drag\", dragContainer);\n    marker.on(\"dragend\", dragEndContainer);\n    marker.on(\"dragstart\", dragStartContainer);\n    this.changeMarkerIcon(marker, point_marker, 35, 35);\n    if (this.conture.markers.length == 1) {\n      this.conture.cords.push(cords);\n      this.conture.cords.push(cords);\n      this.conture.source.data.geometry.coordinates = [this.conture.cords];\n      this.map.addSource(\"conture\", this.conture.source);\n      // this.map.addLayer(this.conture.layer_area)\n      this.map.addLayer(this.conture.layer_line);\n    }\n    if (this.conture.markers.length > 1) {\n      this.conture.cords.pop();\n      this.conture.cords.push(cords);\n      this.conture.cords.push(this.conture.cords[0]);\n      this.conture.source.data.geometry.coordinates = [this.conture.cords];\n      this.map.getSource(\"conture\").setData(this.conture.source.data);\n    }\n    if (this.conture.markers.length == 3) {\n      this.center_marker = new mapboxgl.Marker({\n        draggable: true\n      });\n      this.changeMarkerIcon(this.center_marker, icon_center, 25, 25);\n      let cords = [0, 0];\n      for (let c = 0; c < this.conture.cords.length - 1; c++) {\n        cords[0] += this.conture.cords[c][0];\n        cords[1] += this.conture.cords[c][1];\n      }\n      cords = [cords[0] / (this.conture.cords.length - 1), cords[1] / (this.conture.cords.length - 1)];\n      this.center_marker.setLngLat(cords).addTo(this.map);\n      this.container__dragStartCenterMarker = e => {\n        e.mapElement = this;\n        e.marker = this.center_marker;\n        e.evt = this.data;\n        this.dragStartCenterMarker(e);\n      };\n      this.container__dragCenterMarker = e => {\n        e.mapElement = this;\n        e.marker = this.center_marker;\n        e.evt = this.data;\n        this.dragCenterMarker(e);\n      };\n      this.container__dragEndStartCenterMarker = e => {\n        e.mapElement = this;\n        e.marker = this.center_marker;\n        e.evt = this.data;\n        this.dragEndStartCenterMarker(e);\n      };\n      this.center_marker.on(\"dragstart\", this.container__dragStartCenterMarker);\n      this.center_marker.on(\"drag\", this.container__dragCenterMarker);\n      this.center_marker.on(\"dragend\", this.container__dragEndStartCenterMarker);\n      let cords_markup = this.markupPolygon();\n      this.markup.cords = cords_markup;\n    }\n    if (this.conture.markers.length >= 3) {\n      let cords_markup = this.markupPolygon();\n      this.markup.cords = cords_markup;\n      this.updateRouteLine();\n    }\n\n    ///add sphere\n    this.manager3D.addSphere([coords[0], coords[1], this.params.alt], marker.id);\n    this.last_id += 1;\n    this.getRealSpray(false);\n  }\n  rotate(cords, factor) {\n    let centerCords = this.center_marker.getLngLat();\n    centerCords = [centerCords.lng, centerCords.lat];\n    let rotated_cords = rotateFigureCenter(cords, centerCords, factor * this.params.angle);\n    return rotated_cords;\n  }\n  isValid() {\n    let edges = [];\n    let cords_markup = this.rotate(this.conture.cords, 1);\n    for (let c = 0; c < this.conture.cords.length - 1; c++) {\n      edges.push([cords_markup[c], cords_markup[c + 1]]);\n    }\n    let pr = getProjective(cords_markup);\n    let step = getGeoCordsFromMeters(this.params.line_distance, pr.y_pr.min);\n    let steps = Math.trunc(pr.x_pr.pr / step);\n    if (1 > steps) return false;else return true;\n  }\n  updateMarkup() {\n    this.markup.cords = this.markupPolygon();\n    this.markup.source.data.geometry.coordinates = this.markup.cords;\n    this.updateRouteLine();\n  }\n  updatePolygonPosition() {\n    this.conture.source.data.geometry.coordinates = [this.conture.cords];\n    this.map.getSource(\"conture\").setData(this.conture.source.data);\n    this.updateMarkup();\n  }\n  dragStartCenterMarker(e) {\n    // e.evt.route.tbManager.resetCollisionObjects()\n    let center_cords = e.marker.getLngLat();\n    e.marker.diff = [];\n    for (let cords of this.conture.cords) {\n      e.marker.diff.push([cords[0] - center_cords.lng, cords[1] - center_cords.lat]);\n    }\n  }\n  dragCenterMarker(e) {\n    let center_cords = e.marker.getLngLat();\n    for (let c = 0; c < this.conture.markers.length; c++) {\n      let changed_cords = [e.marker.diff[c][0] + center_cords.lng, e.marker.diff[c][1] + center_cords.lat];\n      this.conture.cords[c] = changed_cords;\n      if (c == 0) {\n        this.conture.cords[this.conture.cords.length - 1] = changed_cords;\n      }\n      this.conture.markers[c].setLngLat(changed_cords);\n    }\n    this.conture.markers.forEach(marker => {\n      this.manager3D.changeCoords(marker.id, [marker.getLngLat().lng, marker.getLngLat().lat, this.params.alt]);\n    });\n    // this.manager3D.changeSphereCoords(0, 0)\n    // this.conture.cords.slice(0, this.conture.cords.length-1).forEach((cords, index) => {\n    //   this.manager3D.sphereArr[index+1].object.setCoords(cords)\n    // })\n    this.updatePolygonPosition();\n    this.updateMarkup();\n    this.getRealSpray(true);\n  }\n  dragEndStartCenterMarker(e) {\n    e.marker.diff = [];\n  }\n  drag(e) {\n    let cords = e.marker.getLngLat();\n    let before_cords = this.conture.cords[e.marker.conture_index];\n    this.conture.cords[e.marker.conture_index] = [cords.lng, cords.lat];\n    if (!this.isValid()) {\n      this.conture.cords[e.marker.conture_index] = before_cords;\n      e.marker.setLngLat(before_cords);\n      return;\n    }\n    this.conture.cords[e.marker.conture_index] = [cords.lng, cords.lat];\n    if (e.marker.conture_index == 0) {\n      this.conture.cords[this.conture.cords.length - 1] = [cords.lng, cords.lat];\n    }\n    this.conture.source.data.geometry.coordinates = [this.conture.cords];\n    this.map.getSource(\"conture\").setData(this.conture.source.data);\n    this.updateCenterMarker();\n    this.updateMarkup();\n\n    //change coords of sphere\n    this.manager3D.changeCoords(e.id, [cords.lng, cords.lat, this.params.alt]);\n    this.getRealSpray(true);\n  }\n  dragStartCont(e) {}\n  dragEndCont(e) {}\n  dragEnd(e) {}\n  updateCenterMarker() {\n    let cords = [0, 0];\n    for (let c = 0; c < this.conture.cords.length - 1; c++) {\n      cords[0] += this.conture.cords[c][0];\n      cords[1] += this.conture.cords[c][1];\n    }\n    cords = [cords[0] / (this.conture.cords.length - 1), cords[1] / (this.conture.cords.length - 1)];\n    this.center_marker.setLngLat(cords);\n  }\n  updateRouteLine() {\n    this.getZoneShift();\n    let route = [];\n    if (this.params.is_rtl === true) {\n      route = [[this.start_marker.getLngLat().lng, this.start_marker.getLngLat().lat, 0]].concat(this.markup.cords).concat([[this.start_marker.getLngLat().lng, this.start_marker.getLngLat().lat, 0]]);\n    } else {\n      route = [[this.start_marker.getLngLat().lng, this.start_marker.getLngLat().lat, 0]].concat(this.markup.cords);\n    }\n    if (this.conture.markers.length >= 3) {\n      this.manager3D.unitSpheres(route);\n      this.manager3D.sphereArr[0].object.set({});\n    }\n  }\n  setPolygon(coords) {\n    if (this.start_marker === null) {\n      this.update_modal_message({\n        active: true,\n        heading: \"Ошибка\",\n        message: \"Сначала добавьте точку старта\"\n      });\n    } else {\n      this.addConturePoint(coords);\n    }\n  }\n  deletePolygon() {\n    if (this.map.getSource(\"conture\")) {\n      this.map.removeLayer(\"line_conture\");\n      this.map.removeSource(\"conture\");\n      this.conture.markers.forEach(marker => {\n        marker.remove();\n      });\n      this.center_marker.remove();\n      this.manager3D.deletePolygon();\n    }\n    this.conture = {\n      markers: [],\n      cords: [],\n      edges: [],\n      source: {\n        'type': 'geojson',\n        'data': {\n          'type': 'Feature',\n          'geometry': {\n            'type': 'Polygon',\n            'coordinates': [[]]\n          }\n        }\n      },\n      layer_line: {\n        'id': 'line_conture',\n        'type': 'line',\n        'source': \"conture\",\n        'layout': {},\n        'paint': {\n          'line-color': '#000',\n          'line-width': 2\n        }\n      }\n    };\n    this.markup = {\n      cords: [],\n      source: {\n        'type': 'geojson',\n        'data': {\n          'type': 'Feature',\n          'geometry': {\n            'type': 'LineString',\n            'coordinates': [[]]\n          }\n        }\n      },\n      layer: {\n        'id': \"markup\",\n        'type': 'line',\n        'source': \"markup\",\n        'layout': {},\n        'paint': {\n          'line-color': '#fff',\n          'line-width': 2\n        }\n      }\n    };\n  }\n}","map":{"version":3,"names":["takeoff_marker","point_marker","icon_center","mapboxgl","SprayManager3d","center","rotateFigureCenter","cords","phi","Math","PI","rotatedFigure","pair","x","y","x_rot","cos","sin","y_rot","push","addTurnaroundDistance","distance","direction","turnaround_distance_y","getGeoCordsFromMeters","cortej","getProjective","map","x_projection","min","max","pr","y_projection","x_pr","y_pr","m","min_lng","step","km_ekv","step_deg","MapManager","constructor","manager3D","update_modal_message","default_","translate_cursor","start_marker","last_id","params","angle","line_distance","turnaround_distance","reverse","is_rtl","alt","wind_speed","wind_direction","conture","markers","edges","source","layer_area","layer_line","markup","layer","calcPerpendVector","lat1","lon1","lat2","lon2","dx","dy","perpDx","perpDy","length","sqrt","meters2degrees","meters","lat","degreesPerMeter","getRealSpray","is_update","stripPoints","base_width","tan","width","opacity","i","halfWidthDegrees","leftLat1","leftLon1","rightLat1","rightLon1","leftLat2","leftLon2","rightLat2","rightLon2","left_first","left_second","right_first","right_second","real_spray","forEach","item","shift_real_spray","getShift","geojson","getSource","setData","setPaintProperty","removeLayer","removeSource","addSource","addLayer","base_coords","directions","radius","Number","coord_arr","coord","coord_x","coord_y","delta_x","delta_y","new_coord_x","new_coord_y","getZoneShift","marker","getLngLat","lng","drawShiftPolygon","toggleCursor","setStartMarker","coords","Marker","draggable","setLngLat","addTo","icon","document","createElement","src","height","getElement","querySelector","remove","append","indicator","className","classList","add","addSphere","deleteObject","updateRouteLine","changeMarkerIcon","Icon","rotatePolygon","updateCenterMarker","updateMarkup","changeLineSpacing","dist","toggleRTL","changeAlt","changeCoords","id","changeWind","key","value","markupPolygon","cords_markup","rotate","c","steps","trunc","x_0","crossings","low","high","j","A","B","min_y","max_y","sort","a","b","cord","addConturePoint","conture_index","dragContainer","e","evt","drag","dragEndContainer","dragEndCont","dragStartContainer","dragStartCont","on","data","geometry","coordinates","pop","center_marker","container__dragStartCenterMarker","mapElement","dragStartCenterMarker","container__dragCenterMarker","dragCenterMarker","container__dragEndStartCenterMarker","dragEndStartCenterMarker","factor","centerCords","rotated_cords","isValid","updatePolygonPosition","center_cords","diff","changed_cords","before_cords","dragEnd","route","concat","unitSpheres","sphereArr","object","set","setPolygon","active","heading","message","deletePolygon"],"sources":["/Users/mihailbaleev/Documents/GitHub/Lastochka_spraying/frontend/src/Spraying/MapManager.js"],"sourcesContent":["import takeoff_marker from \"./img/takeoff_marker.png\";\nimport point_marker from \"./img/point_marker.png\";\nimport icon_center from \"./img/icon_center.png\";\nimport mapboxgl from 'mapbox-gl';\nimport { SprayManager3d } from \"./manager3D\";\nimport { center } from \"@turf/turf\";\n\nfunction rotateFigureCenter(cords, center, phi){\n    phi = phi*Math.PI/180\n    let rotatedFigure = []\n    for(let pair of cords){\n      let x = pair[0]-center[0]\n      let y = pair[1]-center[1]\n      let x_rot = x*Math.cos(phi) - y*Math.sin(phi)\n      let y_rot = x*Math.sin(phi) + y*Math.cos(phi)\n      rotatedFigure.push([\n        x_rot+center[0], y_rot+center[1]\n      ])\n    }\n    return rotatedFigure\n}\n\nfunction addTurnaroundDistance(cords, distance, direction){\n  let turnaround_distance_y = getGeoCordsFromMeters(distance, cords[1])\n  let cortej = []\n  if(direction == true){\n    cortej = [cords[0], cords[1]+turnaround_distance_y]\n  }\n  else{\n    cortej = [cords[0], cords[1]-turnaround_distance_y]\n  }\n  return cortej\n}\n\nfunction getProjective(cords){\n  let x = cords.map(x=>x[0])\n  let y = cords.map(x=>x[1])\n\n  let x_projection = {\n      min:0,\n      max:0,\n      pr:0\n  }\n  let y_projection = {\n      min:0,\n      max:0,\n      pr:0\n  }\n\n  x_projection.min = Math.min(...x)\n  x_projection.max = Math.max(...x)\n  x_projection.pr = x_projection.max - x_projection.min\n  \n  y_projection.min = Math.min(...y)\n  y_projection.max = Math.max(...y)\n  y_projection.pr = y_projection.max - y_projection.min\n\n  return {x_pr:x_projection, y_pr:y_projection}\n}\n\nfunction getGeoCordsFromMeters(m, min_lng){\n  let step = m/1000\n  const km_ekv = 40075.696/360\n  let step_deg = step/(km_ekv*Math.cos(Math.PI*min_lng/180))\n  return step_deg\n}\n\nexport class MapManager{\n  constructor(map, manager3D, update_modal_message, default_){\n    this.map = map \n    this.manager3D = new SprayManager3d(manager3D)\n    this.translate_cursor = false \n    this.start_marker = null\n    this.update_modal_message = update_modal_message\n    this.last_id = 0\n    this.params = {\n      angle: 0,\n      line_distance: 3,\n      turnaround_distance: 0,\n      reverse: false,\n      is_rtl: true,\n      alt: 3.5,\n      wind_speed: 2,\n      wind_direction: \"N\"\n    }\n\n    this.conture = {\n        markers:[],\n        cords:[],\n        edges:[],\n        source:{\n          'type': 'geojson',\n          'data': {\n            'type': 'Feature',\n            'geometry': {\n            'type': 'Polygon',\n            'coordinates': [\n                []\n              ]\n            }\n          }\n        },\n        layer_area:{\n          'id': \"area_conture\",\n          'type': 'fill',\n          'source': \"conture\",\n          'layout': {},\n          'paint': {\n            'fill-color': '#008000',\n            'fill-opacity': 0.5\n            }\n          },\n        layer_line:{\n            'id': 'line_conture',\n            'type': 'line',\n            'source': \"conture\",\n            'layout': {},\n            'paint': {\n              'line-color': '#000',\n              'line-width': 2\n            }\n        }\n    }\n    this.markup = {\n        cords:[],\n        source:{\n          'type': 'geojson',\n          'data': {\n            'type': 'Feature',\n            'geometry': {\n            'type': 'LineString',\n            'coordinates': [\n                []\n              ]\n            }\n          }\n        },\n        layer:{\n          'id': \"markup\",\n          'type': 'line',\n          'source': \"markup\",\n          'layout': {},\n          'paint': {\n          'line-color': '#fff',\n          'line-width': 2\n          }\n        }\n    };\n  }\n\n  calcPerpendVector(lat1, lon1, lat2, lon2){\n    let dx = lon2 - lon1;\n    let dy = lat2 - lat1;\n    let perpDx = -dy;\n    let perpDy = dx;\n    let length = Math.sqrt(perpDx * perpDx + perpDy * perpDy);\n    perpDx /= length;\n    perpDy /= length;\n    return { perpDx, perpDy };\n  }\n  meters2degrees(meters, lat){\n    let degreesPerMeter = 1 / (111320 * Math.cos(lat * Math.PI / 180));\n    return meters * degreesPerMeter;\n  }\n  getRealSpray(is_update){\n    let stripPoints = [];\n    let base_width = 2 * Math.tan(120)\n    let width = 2 * this.params.alt * Math.tan(120)\n    let opacity = base_width/width <= 1 ? base_width/width : 1 \n    if (width >= this.params.line_distance*1.13){width = this.params.line_distance*1.13}\n    for (let i = 0; i < this.markup.cords.length - 1; i++) {\n        let [lat1, lon1] = this.markup.cords[i];\n        let [lat2, lon2] = this.markup.cords[i + 1];\n        let { perpDx, perpDy } = this.calcPerpendVector(lat1, lon1, lat2, lon2);\n        let halfWidthDegrees = this.meters2degrees(width / 2, lat1);\n        let leftLat1 = lat1 + perpDy * halfWidthDegrees;\n        let leftLon1 = lon1 + perpDx * halfWidthDegrees;\n        let rightLat1 = lat1 - perpDy * halfWidthDegrees;\n        let rightLon1 = lon1 - perpDx * halfWidthDegrees;\n        let leftLat2 = lat2 + perpDy * halfWidthDegrees;\n        let leftLon2 = lon2 + perpDx * halfWidthDegrees;\n        let rightLat2 = lat2 - perpDy * halfWidthDegrees;\n        let rightLon2 = lon2 - perpDx * halfWidthDegrees;\n        stripPoints.push({\n          left_first: [leftLat1, leftLon1],\n          left_second: [leftLat2, leftLon2],\n          right_first: [rightLat1, rightLon1],\n          right_second: [rightLat2, rightLon2]\n        })\n    }\n    \n    let real_spray = []\n    stripPoints.forEach(item => {\n      real_spray.push(item.left_first)\n      real_spray.push(item.left_second)\n    })\n    stripPoints.reverse().forEach(item => {\n      real_spray.push(item.right_second)\n      real_spray.push(item.right_first)\n    })\n\n    let shift_real_spray = this.getShift(real_spray)\n\n    if (is_update === true){\n      let geojson = {\n        \"type\": \"FeatureCollection\",\n        \"features\": [{\n            \"type\": \"Feature\",\n            \"properties\": {\"name\": \"sector\"},\n            \"geometry\": {\n                \"type\": \"Polygon\",\n                \"coordinates\": [shift_real_spray]\n            }\n        }]\n      }\n      this.map.getSource(\"real_spray\").setData(geojson)\n      this.map.setPaintProperty(\"real_spray_layer\", \"fill-opacity\", opacity)\n    }else{\n      if (this.map.getSource(\"real_spray\")){\n        this.map.removeLayer(\"real_spray_layer\")\n        this.map.removeSource(\"real_spray\")\n      }\n      let geojson = {\n        \"type\": \"geojson\",\n        \"data\": {\n            \"type\": \"FeatureCollection\",\n            \"features\": [{\n                \"type\": \"Feature\",\n                \"geometry\": {\n                    \"type\": \"Polygon\",\n                    \"coordinates\": [shift_real_spray]\n                }\n            }]\n        }\n      }\n      this.map.addSource(\"real_spray\", geojson)\n      this.map.addLayer({\n        \"id\": \"real_spray_layer\",\n        \"type\": \"fill\",\n        \"source\": \"real_spray\",\n        \"layout\": {},\n        \"paint\": {\n            \"fill-color\": \"#02d402\",\n            \"fill-opacity\": opacity\n        }\n      })\n    }\n  }\n\n  getShift(base_coords){\n    const directions = {\"N\": [0, -1], \"NE\": [-Math.sqrt(2)/2,-Math.sqrt(2)/2], \"E\": [-1, 0], \"SE\": [-Math.sqrt(2)/2, Math.sqrt(2)/2], \"S\": [0,1], \"SW\": [Math.sqrt(2)/2,Math.sqrt(2)/2], \"W\": [1,0], \"NW\": [Math.sqrt(2)/2,-Math.sqrt(2)/2]}\n    const radius = 6378160\n    let wind_speed = Number(this.params.wind_speed)\n    let alt = Number(this.params.alt)\n    let wind_direction = directions[this.params.wind_direction]\n    let coord_arr = []\n    base_coords.forEach(coord => {\n      let coord_x = coord[0]\n      let coord_y = coord[1]\n      let delta_x = 100*wind_speed*Math.sqrt(2*alt/9.81)*wind_direction[0]\n      let delta_y = 100*wind_speed*Math.sqrt(2*alt/9.81)*wind_direction[1]\n      let new_coord_x = coord_x + delta_x/radius\n      let new_coord_y = coord_y + delta_y/radius\n      coord_arr.push([new_coord_x, new_coord_y])\n    })\n    return coord_arr\n  }\n  getZoneShift(){\n    let conture = []\n    this.conture.markers.forEach(marker => {\n      conture.push([marker.getLngLat().lng, marker.getLngLat().lat])\n    })\n    let coord_arr = this.getShift(conture)\n    if (this.conture.markers.length >= 3){\n      this.getRealSpray(true)\n      this.manager3D.drawShiftPolygon(coord_arr)\n    }\n  }\n\n  toggleCursor(){\n    if (this.translate_cursor === true){\n      this.translate_cursor = false \n    }else{\n      this.translate_cursor = true\n    }\n  }\n\n  setStartMarker(coords){\n    if (this.start_marker === null){\n      this.start_marker = new mapboxgl.Marker({draggable: false}).setLngLat(coords).addTo(this.map)\n      let icon = document.createElement('img');\n      icon.src = takeoff_marker;\n      icon.width = 35\n      icon.height = 35\n      this.start_marker.getElement().querySelector(\"svg\").remove()\n      this.start_marker.getElement().append(icon)\n      let indicator = document.createElement('span');\n      indicator.className = \"mapbox_gl_active_indicator\"\n      this.start_marker.getElement().append(indicator)\n      this.start_marker.getElement().classList.add(\"takeoff\")\n      this.manager3D.addSphere([coords[0], coords[1], 0], 0)\n      this.last_id += 1\n    }else{\n      this.start_marker.remove()\n      this.start_marker = null\n      this.setStartMarker(coords)\n      this.manager3D.deleteObject(0)\n      this.manager3D.addSphere([coords[0], coords[1], 0], 0)\n    }\n    this.updateRouteLine()\n  }\n\n  changeMarkerIcon(marker, Icon, width, height) {\n    let icon = document.createElement('img');\n    icon.src = Icon;\n    icon.width = width\n    icon.height = height\n    marker.getElement().classList.add(\"mapboxgl-marker__polygon\")\n    marker.getElement().querySelector(\"svg\").remove()\n    marker.getElement().append(icon)\n    let indicator = document.createElement('span');\n    indicator.className = \"mapbox_gl_active_indicator\"\n    marker.getElement().append(indicator)\n  }\n\n  rotatePolygon(angle){ ///real rotate\n    this.params.angle = Number(angle)\n    if (this.conture.cords.length != 0){\n      this.updateCenterMarker()\n      this.updateMarkup()\n      this.getRealSpray(true)\n    }\n  }\n  changeLineSpacing(dist){\n    this.params.line_distance = Number(dist)\n    if (this.conture.cords.length != 0){\n      this.updateCenterMarker()\n      this.updateMarkup()\n      this.getRealSpray(true)\n    }\n  }\n  toggleRTL(){\n    if (this.params.is_rtl === true){\n      this.params.is_rtl = false\n    }else{\n      this.params.is_rtl = true \n    }\n    if (this.conture.markers.length != 0){\n      this.updateCenterMarker()\n      this.updateMarkup()\n    }\n  }\n  changeAlt(alt){\n    this.params.alt = Number(alt) \n    if (this.conture.cords.length != 0){\n      this.updateCenterMarker()\n      this.updateMarkup()\n      this.conture.markers.forEach(marker => {\n        this.manager3D.changeCoords(marker.id, [marker.getLngLat().lng, marker.getLngLat().lat, this.params.alt])\n      })\n      this.getRealSpray(true)\n    }\n  }\n  changeWind(key, value){\n    this.params[key] = value \n    this.getZoneShift()\n  }\n\n  markupPolygon(){\n    let edges = []\n    let cords_markup = this.rotate(this.conture.cords, 1)\n    for(let c = 0; c < this.conture.cords.length-1; c++){\n      edges.push([cords_markup[c], cords_markup[c+1]])\n    }\n    let pr = getProjective(cords_markup)\n    let step = getGeoCordsFromMeters(this.params.line_distance, pr.y_pr.min)\n    let steps = Math.trunc(pr.x_pr.pr/step)\n    let cords = []\n    for(let i = 0; i < steps; i++){\n      let x_0 = pr.x_pr.min+step*(i+1)\n      let crossings = []\n      let low = [1000, null];\n      let high = [-1000, null];\n      for(let j = 0; j < edges.length; j++){\n          let A = edges[j][0]\n          let B = edges[j][1]\n          let y = (B[1]-A[1])*(x_0-B[0])/(B[0]-A[0])+B[1]\n          let min_y = Math.min(A[1],B[1])\n          let max_y = Math.max(A[1],B[1])\n          if(y>min_y && y< max_y){\n            if(y>high[0]){\n              high[0] = y\n              high[1] = [x_0, y]\n            }\n            else if(y<low[0]){\n              low[0] = y\n              low[1] = [x_0, y]\n            }\n            crossings.push([x_0, y])\n          }\n      }\n      crossings = crossings.sort(function(a, b){return a[1]-b[1]})\n\n      low[1] = crossings[0]\n      high[1] = crossings[crossings.length-1]\n\n      low[1] = addTurnaroundDistance(low[1], this.params.turnaround_distance, false)\n      high[1] = addTurnaroundDistance(high[1], this.params.turnaround_distance, true)\n      if((cords.length+2)%4 == 0){\n        cords.push(low[1])\n        cords.push(high[1])\n      }\n      else{\n        cords.push(high[1])\n        cords.push(low[1])\n      }\n    }\n    cords = this.rotate(cords, -1)\n    if (cords.length == 0){\n      return this.conture.cords\n    }else{\n      cords = cords.map(cord => {return [cord[0], cord[1], this.params.alt]})\n      return cords\n    }\n  }\n\n  addConturePoint(coords){\n      let cords = coords;\n      let marker = new mapboxgl.Marker(\n          {\n              draggable: true\n          }\n      ).setLngLat(cords).addTo(this.map);\n      marker.conture_index = this.conture.markers.length;\n      marker.id = this.last_id\n      this.conture.markers.push(marker)\n      let dragContainer = (e) => {e.marker = marker; e.evt = {}; e.id=marker.id; this.drag(e)}\n      let dragEndContainer = (e) => {e.evt = {}; this.dragEndCont(e)}\n      let dragStartContainer = (e) => {e.evt = {}; this.dragStartCont(e)}\n      marker.on(\"drag\", dragContainer)\n      marker.on(\"dragend\", dragEndContainer)\n      marker.on(\"dragstart\", dragStartContainer)\n      this.changeMarkerIcon(marker, point_marker, 35, 35)\n      if(this.conture.markers.length == 1){\n        this.conture.cords.push(cords)\n        this.conture.cords.push(cords)\n        this.conture.source.data.geometry.coordinates = [this.conture.cords]\n        this.map.addSource(\"conture\", this.conture.source)\n        // this.map.addLayer(this.conture.layer_area)\n        this.map.addLayer(this.conture.layer_line)\n      }\n      if(this.conture.markers.length > 1){\n          this.conture.cords.pop()\n          this.conture.cords.push(cords)\n          this.conture.cords.push(this.conture.cords[0])\n          this.conture.source.data.geometry.coordinates = [this.conture.cords]\n          this.map.getSource(\"conture\").setData(this.conture.source.data)\n      }\n      if(this.conture.markers.length == 3){\n        this.center_marker = new mapboxgl.Marker({\n          draggable:true\n        })\n        this.changeMarkerIcon(this.center_marker, icon_center, 25, 25)\n        let cords = [0,0]\n        for(let c = 0; c < this.conture.cords.length-1; c++){\n          cords[0] += this.conture.cords[c][0]\n          cords[1] += this.conture.cords[c][1]\n        }\n        cords = [cords[0]/(this.conture.cords.length-1), cords[1]/(this.conture.cords.length-1)]\n        this.center_marker.setLngLat(cords).addTo(this.map);\n\n        this.container__dragStartCenterMarker = (e) => {e.mapElement = this; e.marker = this.center_marker; e.evt = this.data; this.dragStartCenterMarker(e)}\n        this.container__dragCenterMarker = (e) => {e.mapElement = this; e.marker = this.center_marker; e.evt = this.data; this.dragCenterMarker(e)}\n        this.container__dragEndStartCenterMarker = (e) => {e.mapElement = this; e.marker = this.center_marker; e.evt = this.data; this.dragEndStartCenterMarker(e)}\n    \n        this.center_marker.on(\"dragstart\", this.container__dragStartCenterMarker)\n        this.center_marker.on(\"drag\", this.container__dragCenterMarker)\n        this.center_marker.on(\"dragend\", this.container__dragEndStartCenterMarker)\n        let cords_markup = this.markupPolygon()\n        this.markup.cords = cords_markup\n      }\n      if (this.conture.markers.length >= 3){\n        let cords_markup = this.markupPolygon()\n        this.markup.cords = cords_markup\n        this.updateRouteLine()\n      }\n\n    ///add sphere\n    this.manager3D.addSphere([coords[0], coords[1], this.params.alt], marker.id)\n    this.last_id += 1\n    this.getRealSpray(false)\n  }\n\n  rotate(cords, factor){\n    let centerCords = this.center_marker.getLngLat()\n    centerCords = [centerCords.lng, centerCords.lat]\n    let rotated_cords = rotateFigureCenter(cords, centerCords, factor*this.params.angle)\n    return rotated_cords\n  }\n  isValid(){\n    let edges = []\n    let cords_markup = this.rotate(this.conture.cords, 1)\n    for(let c = 0; c < this.conture.cords.length-1; c++){\n      edges.push([cords_markup[c], cords_markup[c+1]])\n    }\n    let pr = getProjective(cords_markup)\n    let step = getGeoCordsFromMeters(this.params.line_distance, pr.y_pr.min)\n    let steps = Math.trunc(pr.x_pr.pr/step)\n    if(1 > steps) return false\n    else return true\n  }\n\n  updateMarkup(){\n    this.markup.cords = this.markupPolygon()\n    this.markup.source.data.geometry.coordinates = this.markup.cords\n    this.updateRouteLine()\n  }\n\n  updatePolygonPosition(){\n    this.conture.source.data.geometry.coordinates = [this.conture.cords]\n    this.map.getSource(\"conture\").setData(this.conture.source.data)\n    this.updateMarkup()\n  }\n\n  dragStartCenterMarker(e){\n    // e.evt.route.tbManager.resetCollisionObjects()\n    let center_cords = e.marker.getLngLat()\n    e.marker.diff = []\n    for(let cords of this.conture.cords){\n      e.marker.diff.push(\n        [cords[0]-center_cords.lng, cords[1]-center_cords.lat]\n      )\n    }\n  }\n  dragCenterMarker(e){\n    let center_cords = e.marker.getLngLat()\n    for(let c = 0; c < this.conture.markers.length; c++){\n      let changed_cords = [e.marker.diff[c][0]+center_cords.lng, e.marker.diff[c][1]+center_cords.lat]\n      this.conture.cords[c] = changed_cords\n      if(c == 0){\n        this.conture.cords[this.conture.cords.length-1] = changed_cords\n      }\n      this.conture.markers[c].setLngLat(changed_cords)\n    }\n    this.conture.markers.forEach(marker => {\n      this.manager3D.changeCoords(marker.id, [marker.getLngLat().lng, marker.getLngLat().lat, this.params.alt])\n    })\n    // this.manager3D.changeSphereCoords(0, 0)\n    // this.conture.cords.slice(0, this.conture.cords.length-1).forEach((cords, index) => {\n    //   this.manager3D.sphereArr[index+1].object.setCoords(cords)\n    // })\n    this.updatePolygonPosition()\n    this.updateMarkup()\n    this.getRealSpray(true)\n  }\n  dragEndStartCenterMarker(e){\n    e.marker.diff = []\n  }\n  drag(e){\n    let cords = e.marker.getLngLat()\n    let before_cords = this.conture.cords[e.marker.conture_index]\n    this.conture.cords[e.marker.conture_index] = [cords.lng, cords.lat]\n    if(!this.isValid()){\n      this.conture.cords[e.marker.conture_index] = before_cords\n      e.marker.setLngLat(before_cords)\n      return\n    }\n\n    this.conture.cords[e.marker.conture_index] = [cords.lng, cords.lat]\n    if(e.marker.conture_index == 0){\n      this.conture.cords[this.conture.cords.length-1] = [cords.lng, cords.lat]\n    }\n    this.conture.source.data.geometry.coordinates = [this.conture.cords]\n    this.map.getSource(\"conture\").setData(this.conture.source.data)\n    this.updateCenterMarker()\n    this.updateMarkup()\n\n    //change coords of sphere\n    this.manager3D.changeCoords(e.id, [cords.lng, cords.lat, this.params.alt])\n    this.getRealSpray(true)\n  }\n  dragStartCont(e){\n    \n  }\n  dragEndCont(e){\n    \n  }\n  dragEnd(e){\n    \n  }\n\n  updateCenterMarker(){\n    let cords = [0,0]\n    for(let c = 0; c < this.conture.cords.length-1; c++){\n      cords[0] += this.conture.cords[c][0]\n      cords[1] += this.conture.cords[c][1]\n    }\n    cords = [cords[0]/(this.conture.cords.length-1), cords[1]/(this.conture.cords.length-1)]\n    this.center_marker.setLngLat(cords)\n  }\n\n  updateRouteLine(){\n    this.getZoneShift()\n    let route = []\n    if (this.params.is_rtl === true){\n      route = [[this.start_marker.getLngLat().lng, this.start_marker.getLngLat().lat, 0]].concat(this.markup.cords).concat([[this.start_marker.getLngLat().lng, this.start_marker.getLngLat().lat, 0]])\n    }else{\n      route = [[this.start_marker.getLngLat().lng, this.start_marker.getLngLat().lat, 0]].concat(this.markup.cords)\n    }   \n    if (this.conture.markers.length >= 3){\n      this.manager3D.unitSpheres(route)\n      this.manager3D.sphereArr[0].object.set({})\n    }\n  }\n\n  setPolygon(coords){\n    if (this.start_marker === null){\n      this.update_modal_message({active: true, heading: \"Ошибка\", message: \"Сначала добавьте точку старта\"})\n    }else{\n      this.addConturePoint(coords)\n    }\n  }\n  deletePolygon(){\n    if (this.map.getSource(\"conture\")){\n      this.map.removeLayer(\"line_conture\")\n      this.map.removeSource(\"conture\")  \n      this.conture.markers.forEach(marker => {\n        marker.remove()\n      })\n      this.center_marker.remove()\n      this.manager3D.deletePolygon()\n    }\n    this.conture = {\n      markers:[],\n      cords:[],\n      edges:[],\n      source:{\n        'type': 'geojson',\n        'data': {\n          'type': 'Feature',\n          'geometry': {\n          'type': 'Polygon',\n          'coordinates': [\n              []\n            ]\n          }\n        }\n      },\n      layer_line:{\n          'id': 'line_conture',\n          'type': 'line',\n          'source': \"conture\",\n          'layout': {},\n          'paint': {\n          'line-color': '#000',\n          'line-width': 2\n          }\n      }\n    }\n    this.markup = {\n        cords:[],\n        source:{\n          'type': 'geojson',\n          'data': {\n            'type': 'Feature',\n            'geometry': {\n            'type': 'LineString',\n            'coordinates': [\n                []\n              ]\n            }\n          }\n        },\n        layer:{\n          'id': \"markup\",\n          'type': 'line',\n          'source': \"markup\",\n          'layout': {},\n          'paint': {\n          'line-color': '#fff',\n          'line-width': 2\n          }\n        }\n    }\n  }\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}